<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Backend/Java/ThreadLocal/ThreadLocal" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">ThreadLocal | DocHub</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ilcb.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ilcb.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ilcb.github.io/docs/backend/java/thread-local"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="algolia-site-verification" content="7AC2C149ACF91D98"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ThreadLocal | DocHub"><meta data-rh="true" name="description" content="ThreadLocal"><meta data-rh="true" property="og:description" content="ThreadLocal"><meta data-rh="true" name="keywords" content="Java"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ilcb.github.io/docs/backend/java/thread-local"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/docs/backend/java/thread-local" hreflang="zh"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/en/docs/backend/java/thread-local" hreflang="en"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/docs/backend/java/thread-local" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KH2JHIT03F-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DocHub RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DocHub Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="DocHub" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.ea66e0ae.css">
<script src="/assets/js/runtime~main.ae44f0bf.js" defer="defer"></script>
<script src="/assets/js/main.4b10d5d1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DocHub</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/backend/java/io">后端</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Wiki</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/backend/algorithm/sort">算法</a></li><li><a class="dropdown__link" href="/docs/backend/design-pattern/rules">设计模式</a></li><li><a class="dropdown__link" href="/docs/wiki/uml/class">UML</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">云原生</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/cloud-native/docker/install">容器</a></li><li><a class="dropdown__link" href="/docs/cloud-native/harbor/install-harbor">镜像仓库</a></li><li><a class="dropdown__link" href="/docs/cloud-native/orchestration/install-k8s">容器编排</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/Tools/消息队列/RabbitMQ原理">工具</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/backend/java/io">Java</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/io">Java IO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/concurrent">Java 并发之锁</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/exception">Java 异常</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/backend/java/thread-local">ThreadLocal</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/thread-pool">Java 线程池</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/iterator">Java 迭代器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/backend/java/thread">我是一个线程</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/backend/spring/aop-example">Spring</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/backend/database/mysql/transaction">数据库</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Java</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ThreadLocal</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>ThreadLocal</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal-是什么">ThreadLocal 是什么<a href="#threadlocal-是什么" class="hash-link" aria-label="ThreadLocal 是什么的直接链接" title="ThreadLocal 是什么的直接链接">​</a></h2>
<ul>
<li>早在 JDK 1.2 的版本中就提供 java.lang.ThreadLocal，ThreadLocal 为解决多线程程序的
并发问题提供了一种新的思路。</li>
<li>ThreadLocal 可以看做是一个容器，容器里面存放着属于当前线程的变量。当使用 ThreadLocal 维护变量时，ThreadLocal 为每个使用该变量的线程提供独立的变量副本，所以每一个线程都可以独立地改变自己的副本，而不会影响其它线程所对应的副本。</li>
<li>从线程的角度看，目标变量就象是线程的本地变量，这也是类名中“Local”所要表达的意思。</li>
<li>官方对 ThreadLocal 的解释：该类提供了线程局部 (thread-local) 变量。这些变量
不同于它们的普通对应物，因为访问某个变量（通过其 get 或 set 方法）的每个线程都
有自己的局部变量，它独立于变量的初始化副本。</li>
</ul>
<p>ThreadLocal 实例通常是类中的 private static 字段，它们希望将状态与某一个线程
（例如，用户 ID 或事务 ID）相关联;</p>
<p>我们从中提取出 3 个要点：</p>
<ol>
<li>每个线程都有自己的局部变量
每个线程都有一个独立于其他线程的上下文来保存这个变量，一个线程的本地变量对其他线程是不可见的</li>
<li>独立于变量的初始化副本
ThreadLocal 可以给一个初始值，而每个线程都会获得这个初始化值的一个副本，这样才能保证不同的线程都有一份拷贝。</li>
<li>状态与某一个线程相关联
ThreadLocal 不是用于解决共享变量的问题的，不是为了协调线程同步而存在，而是为了方便每个线程处理自己的状态而引入的一个机制，理解这点对正确使用 ThreadLocal 至关重要。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal-的接口方法">ThreadLocal 的接口方法<a href="#threadlocal-的接口方法" class="hash-link" aria-label="ThreadLocal 的接口方法的直接链接" title="ThreadLocal 的接口方法的直接链接">​</a></h2>
<p>ThreadLocal 类接口:</p>
<ul>
<li>void set(Object value)：设置当前线程的线程局部变量的值。</li>
<li>public Object get()：该方法返回当前线程所对应的线程局部变量。</li>
<li>public void remove()：将当前线程局部变量的值删除，目的是为了减少内存的占用，该方法是
JDK 5.0 新增的方法。需要指出的是，当线程结束后，对应该线程的局部变量将自动被垃圾回收，
所以显式调用该方法清除线程的局部变量并不是必须的操作，但它可以加快内存回收的速度。</li>
<li>protected Object initialValue()：返回该线程局部变量的初始值，该方法是一个
protected 的方法显然是为了让子类覆盖而设计的。这个方法是一个延迟调用方法，在线程第 1 次调用 get()或 set(Object)时才执行，并且仅执行 1 次，ThreadLocal 中的缺省实现直接
返回一个 null。</li>
</ul>
<p>在 JDK5.0 中，ThreadLocal 已经支持泛型，该类的类名已经变为 <code>ThreadLocal&lt;T&gt;</code>。API 方法也相应进行了调整，新版本的 API 方法分别是 void set(T value)、T get()以及 T initialValue()。</p>
<p><strong>ThreadLocal 是如何做到为每一个线程维护变量的副本的呢？其实实现的思路很简单：在 ThreadLocal 类中有一个 Map，用于存储每一个线程的变量副本，Map 中元素的键为线程
对象，而值对应线程的变量副本。</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="示例-1">示例 1<a href="#示例-1" class="hash-link" aria-label="示例 1的直接链接" title="示例 1的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocalTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Integer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> threads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            threads</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">//获取当前线程的本地变量，然后累加5次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">Integer</span><span class="token plain"> localValue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        localValue</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">//重新设置累加后的本地变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">localValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;====&gt;&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Thread-&gt;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token plain"> thread </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> threads</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>结果：每个线程累加后的结果都是 5，各个线程处理自己的本地变量值，线程之间互不影响</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;0====&gt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;4====&gt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;3====&gt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;1====&gt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;2====&gt;5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="示例-2">示例 2<a href="#示例-2" class="hash-link" aria-label="示例 2的直接链接" title="示例 2的直接链接">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocalDemo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">increase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Index</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Index</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> threads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            threads</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Runnable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">//获取当前线程的本地变量，然后累加5次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">Index</span><span class="token plain"> num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        num</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">increase</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">//重新设置累加后的本地变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;====&gt;&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Thread-&gt;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token plain"> thread </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> threads</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>结果：</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;0====&gt;5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;1====&gt;10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;2====&gt;15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;4====&gt;20</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-&gt;3====&gt;25</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为什么线程本地变量又失效了呢？再来回味一下 “ThreadLocal 可以给一个初始值，而每个线程都会获得这个初始化值的一个副本” ，再来看一下上面代码中定义 ThreadLocal 的地方：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Index</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面代码中，我们通过覆盖 initialValue 函数来给我们的 ThreadLocal 提供初始值，每个线程都会获取这个初始值的一个副本。而现在我们的初始值是一个定义好的一个对象，num 是这个对象的引用。
换句话说我们的初始值是一个引用，引用的副本和引用指向的不就是同一个对象吗？</p>
<p><img decoding="async" loading="lazy" alt="1" src="data:image/png;base64,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" width="597" height="413" class="img_ev3q">
如果想给每一个线程都保存一个 Index 对象应该怎么办呢？那就是创建对象的副本而不是对象引用的副本：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Index</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> local </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocal</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="2" src="data:image/png;base64,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" width="555" height="390" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threadlocal-源码">ThreadLocal 源码<a href="#threadlocal-源码" class="hash-link" aria-label="ThreadLocal 源码的直接链接" title="ThreadLocal 源码的直接链接">​</a></h2>
<p>ThreadLocal 有一个内部类 ThreadLocalMap，这个 ThreadLocalMap 的作用非常关键，它就是线程真正保存线程自己本地变量的容器。
每一个线程都有自己的单独的一个 ThreadLocalMap 实例，其所有的本地变量都会保存到这一个 map 中。现在就让我们从 ThreadLocal 的 get 和 set 这两个最常用的方法开始分析：
get()方法：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//获取当前执行线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//取得当前线程的ThreadLocalMap实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//如果map不为空，说明该线程已经有了一个ThreadLocalMap实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//map中保存线程的所有的线程本地变量，我们要去查找当前线程本地变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">ThreadLocalMap</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">Entry</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getEntry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//如果当前线程本地变量存在这个map中，则返回其对应的值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//如果map不存在或者map中不存在当前线程本地变量，返回初始值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setInitialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>线程隔离的秘密，就在于 ThreadLocalMap 这个类。ThreadLocalMap 是 ThreadLocal 类的一个静态内部类，它实现了键值对的设置和获取，每个线程中都有一个独立的 ThreadLocalMap 副本，它所存储的值，只能被当前线程读取和修改。
ThreadLocal 类通过操作每一个线程特有的 ThreadLocalMap 副本，从而实现了变量访问在不同线程中的隔离。因为每个线程的变量都是自己特有的，完全不会有并发错误。
还有一点就是，ThreadLocalMap 存储的键值对中的键是 this 对象指向的 ThreadLocal 对象，而值就是你所设置的对象了。
一个线程对象第一次使用线程本地变量的时候，需要对这个 threadLocals 属性进行初始化操作。
注意要区别 “线程第一次使用本地线程变量”和“第一次使用某一个线程本地线程变量”。</p>
<p>set()方法:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Thread</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	   map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//说明线程第一次使用线程本地变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">createMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>getMap()方法:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//直接返回线程对象的threadLocals属性</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadLocals</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>setInitialValue()方法:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setInitialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//获取初始化值，initialValue 就是我们之前覆盖的方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">T</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Thread</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//如果map不为空，将初始化值放入到当前线程的ThreadLocalMap对象中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">map </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	</span><span class="token comment" style="color:#999988;font-style:italic">//当前线程第一次使用本地线程变量，需要对map进行初始化工作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">createMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//返回初始化值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>remove()方法:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//获取当前线程的ThreadLocalMap对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">ThreadLocalMap</span><span class="token plain"> m </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//如果map不为空，则删除该本地变量的值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="自定义-threadlocal">自定义 ThreadLocal<a href="#自定义-threadlocal" class="hash-link" aria-label="自定义 ThreadLocal的直接链接" title="自定义 ThreadLocal的直接链接">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Collections</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">HashMap</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token import namespace" style="opacity:0.7">java</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import namespace" style="opacity:0.7">util</span><span class="token import namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token import class-name">Map</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ThreadLocalDefine</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token class-name">Map</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Thread</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> container </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Collections</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">synchronizedMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HashMap</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Thread</span><span class="token generics punctuation" style="color:#393A34">,</span><span class="token generics"> </span><span class="token generics class-name">T</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Thread</span><span class="token plain"> thread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">T</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">containsKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">thread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Thread</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token class-name">Sequence</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">SequenceC</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">Sequence</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">ThreadLocalDefine</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> numberContainer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ThreadLocalDefine</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Integer</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">protected</span><span class="token plain"> </span><span class="token class-name">Integer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">initialValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       numberContainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numberContainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> numberContainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Sequence</span><span class="token plain"> sequence </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">SequenceC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ClientThread</span><span class="token plain"> thread1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ClientThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sequence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ClientThread</span><span class="token plain"> thread2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ClientThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sequence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ClientThread</span><span class="token plain"> thread3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">ClientThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sequence</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        thread1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        thread2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        thread3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>结果：</p>
<div class="language-txt codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-txt codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Thread-0 =&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-0 =&gt; 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-0 =&gt; 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-1 =&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-1 =&gt; 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-1 =&gt; 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-2 =&gt; 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-2 =&gt; 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Thread-2 =&gt; 3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Backend/Java/ThreadLocal/ThreadLocal.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/backend/java/exception"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Java 异常</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/backend/java/thread-pool"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Java 线程池</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#threadlocal-是什么" class="table-of-contents__link toc-highlight">ThreadLocal 是什么</a></li><li><a href="#threadlocal-的接口方法" class="table-of-contents__link toc-highlight">ThreadLocal 的接口方法</a><ul><li><a href="#示例-1" class="table-of-contents__link toc-highlight">示例 1</a></li><li><a href="#示例-2" class="table-of-contents__link toc-highlight">示例 2</a></li></ul></li><li><a href="#threadlocal-源码" class="table-of-contents__link toc-highlight">ThreadLocal 源码</a></li><li><a href="#自定义-threadlocal" class="table-of-contents__link toc-highlight">自定义 ThreadLocal</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/Tutorial/React Native跨端开发环境的副本/React Native跨端开发环境">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ilcb" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DocHub, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>