<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-CloudNative/Docker/Docker构建OnlyOffice集群" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Docker 构建 OnlyOffice 集群 | DocHub</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ilcb.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ilcb.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ilcb.github.io/docs/cloud-native/docker/build-onlyoffice-cluster"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Docker 构建 OnlyOffice 集群 | DocHub"><meta data-rh="true" name="description" content="Docker 构建 OnlyOffice 集群"><meta data-rh="true" property="og:description" content="Docker 构建 OnlyOffice 集群"><meta data-rh="true" name="keywords" content="Docker"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ilcb.github.io/docs/cloud-native/docker/build-onlyoffice-cluster"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/docs/cloud-native/docker/build-onlyoffice-cluster" hreflang="zh"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/en/docs/cloud-native/docker/build-onlyoffice-cluster" hreflang="en"><link data-rh="true" rel="alternate" href="https://ilcb.github.io/docs/cloud-native/docker/build-onlyoffice-cluster" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DocHub RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DocHub Atom Feed"><link rel="stylesheet" href="/assets/css/styles.1724a0b2.css">
<script src="/assets/js/runtime~main.afe29cab.js" defer="defer"></script>
<script src="/assets/js/main.5a3ffcb2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">DocHub</b></a><a class="navbar__item navbar__link" href="/docs/backend/java/io">后端</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Wiki</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/backend/algorithm/sort">算法</a></li><li><a class="dropdown__link" href="/docs/backend/design-pattern/rules">设计模式</a></li><li><a class="dropdown__link" href="/docs/wiki/uml/class">UML</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">云原生</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/cloud-native/docker/install">容器</a></li><li><a class="dropdown__link" href="/docs/cloud-native/harbor/install-harbor">镜像仓库</a></li><li><a class="dropdown__link" href="/docs/cloud-native/orchestration/install-k8s">容器编排</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/Tools/消息队列/RabbitMQ原理">工具</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cloud-native/docker/install">安装 Docker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/cloud-native/docker/build-minio">Docker构建</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-minio">Docker 构建 MinIO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-redis">Docker 构建 Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-kafka">Docker 构建 Kafka</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-ngnix">Docker 构建 Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-nacos">Docker 构建 Nacos</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-mongo">Docker 构建 MongoDB</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-rabbitmq">Docker 构建 RabbitMQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-rocketmq">Docker 构建 RocketMQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-zookeeper">Docker 构建 ZooKeeper</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-mysql">Docker 构建 MySQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-postgresql">Docker 构建 PostgreSQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-prometheus">Docker 构建 Prometheus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-elk">Docker 构建 ELK</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/cloud-native/docker/build-onlyoffice-cluster">Docker 构建 OnlyOffice 集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/cloud-native/docker/build-jenkins">Docker 构建 Jenkins</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Docker构建</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Docker 构建 OnlyOffice 集群</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Docker 构建 OnlyOffice 集群</h1></header>
<h1>1.选型</h1>
<p>因为项目需要，需要在内网的环境下部署一套 office 的在线编辑软件。综合对比了一下网上的几种主流的解决方案，感觉 onlyoffice 比较合适。
对比如下，摘自<a href="http://www.dzzoffice.com/" target="_blank" rel="noopener noreferrer">http://www.dzzoffice.com/</a></p>
<table><thead><tr><th>解决方案</th><th>在线预览</th><th>在线编辑</th><th>本地依赖</th><th>内网使用</th><th>私有化部署</th><th>免费使用</th></tr></thead><tbody><tr><td>onlyoffice</td><td>√</td><td>√</td><td>无</td><td>√</td><td>√</td><td>√ 最大 20 连接数</td></tr><tr><td>collabora</td><td>√</td><td>√</td><td>无</td><td>√</td><td>√</td><td>√ 最大 20 连接数</td></tr><tr><td>MS Office Online</td><td>√</td><td>√</td><td>无</td><td>√</td><td>√</td><td>预览免费编辑需购买</td></tr><tr><td>google Doc</td><td>√</td><td>√</td><td>无</td><td>×</td><td>×</td><td>√</td></tr><tr><td>永中 Office</td><td>√</td><td>×</td><td>无</td><td>×</td><td>×</td><td>√</td></tr><tr><td>pageOffice</td><td>√</td><td>√</td><td>Office 软件</td><td>√</td><td>√</td><td>×</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-onlyoffice-优点">1.1 onlyOffice 优点<a href="#11-onlyoffice-优点" class="hash-link" aria-label="1.1 onlyOffice 优点的直接链接" title="1.1 onlyOffice 优点的直接链接">​</a></h2>
<ol>
<li>文档还原度非常高，复杂文档还原度最好。</li>
<li>安装部署方便，不需要独立服务器，支持 docker 容器安装，支持 windows 下部署。</li>
<li>有社区版可免费使用（限制 20 连接数），同时提供多种版本可供企业购买使用，价格较便宜，按每服务器收取。</li>
<li>有详尽开发文档，二次开发方便。</li>
<li>提供贴牌服务。</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-onlyoffice-项目信息">1.2 OnlyOffice 项目信息<a href="#12-onlyoffice-项目信息" class="hash-link" aria-label="1.2 OnlyOffice 项目信息的直接链接" title="1.2 OnlyOffice 项目信息的直接链接">​</a></h2>
<p>onlyofficeAPI文档：<a href="https://api.onlyoffice.com/editors/basic" target="_blank" rel="noopener noreferrer">https://api.onlyoffice.com/editors/basic</a>
onlyoffice 项目地址：<a href="https://github.com/ONLYOFFICE/Docker-DocumentServer" target="_blank" rel="noopener noreferrer">https://github.com/ONLYOFFICE/Docker-DocumentServer</a>
官方示例：<a href="https://api.onlyoffice.com/zh/editors/basic" target="_blank" rel="noopener noreferrer">https://api.onlyoffice.com/zh/editors/basic</a></p>
<h1>2 依赖环境安装</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-安装-docker">2.1 安装 Docker<a href="#21-安装-docker" class="hash-link" aria-label="2.1 安装 Docker的直接链接" title="2.1 安装 Docker的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="211-安装-docker">2.1.1 安装 Docker<a href="#211-安装-docker" class="hash-link" aria-label="2.1.1 安装 Docker的直接链接" title="2.1.1 安装 Docker的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-fsSL</span><span class="token plain"> https://get.docker.com </span><span class="token operator" style="color:#393A34">|</span><span class="token function" style="color:#d73a49">bash</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-s</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--mirror</span><span class="token plain"> Aliyun</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="212-检测-docker-是否安装成功">2.1.2 检测 Docker 是否安装成功<a href="#212-检测-docker-是否安装成功" class="hash-link" aria-label="2.1.2 检测 Docker 是否安装成功的直接链接" title="2.1.2 检测 Docker 是否安装成功的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ps</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="213-设置-docker-开机启动">2.1.3 设置 docker 开机启动<a href="#213-设置-docker-开机启动" class="hash-link" aria-label="2.1.3 设置 docker 开机启动的直接链接" title="2.1.3 设置 docker 开机启动的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> docker.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="214-设置-docker-镜像源">2.1.4 设置 docker 镜像源<a href="#214-设置-docker-镜像源" class="hash-link" aria-label="2.1.4 设置 docker 镜像源的直接链接" title="2.1.4 设置 docker 镜像源的直接链接">​</a></h3>
<p>docker 镜像从官方 dockerHub 下载会很慢，可以设置国内镜像源来加速下载</p>
<p><strong>编辑如下文件:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> /etc/docker/daemon.json</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>内容为</strong></p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;registry-mirrors&quot;: [&quot;https://awkamezj.mirror.aliyuncs.com&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>修改完成后重启 docker</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl daemon-reload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-安装-nginx">2.2 安装 nginx<a href="#22-安装-nginx" class="hash-link" aria-label="2.2 安装 nginx的直接链接" title="2.2 安装 nginx的直接链接">​</a></h2>
<p>nginx 在构建集群时需要用来做负载，也可以使用<code>HAProxy</code>来做负载均衡</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-docker-安装-nginx">2.2.1 docker 安装 nginx<a href="#221-docker-安装-nginx" class="hash-link" aria-label="2.2.1 docker 安装 nginx的直接链接" title="2.2.1 docker 安装 nginx的直接链接">​</a></h3>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#1.查询镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker search nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#2.下载镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-nginx-服务配置及启动">2.2.2 nginx 服务配置及启动<a href="#222-nginx-服务配置及启动" class="hash-link" aria-label="2.2.2 nginx 服务配置及启动的直接链接" title="2.2.2 nginx 服务配置及启动的直接链接">​</a></h3>
<p>容器中的文件内容是可以被修改的，但是<strong>一旦容器重启，所有写入到容器中的，针对数据文件、配置文件的修改都将丢失</strong>。所以为了保存容器的运行状态，执行结果，我们需要将容器内的一些重要的数据文件、日志文件、配置文件映射到宿主机上。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="223-启动容器">2.2.3 启动容器<a href="#223-启动容器" class="hash-link" aria-label="2.2.3 启动容器的直接链接" title="2.2.3 启动容器的直接链接">​</a></h3>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run --name nginx -p 80:80 -d nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="224-目录映射">2.2.4 目录映射<a href="#224-目录映射" class="hash-link" aria-label="2.2.4 目录映射的直接链接" title="2.2.4 目录映射的直接链接">​</a></h3>
<table><thead><tr><th></th><th><strong>容器中路径</strong></th><th><strong>宿主机中自定义映射路径</strong></th></tr></thead><tbody><tr><td>存储网站网页的目录</td><td>/usr/share/nginx/html</td><td>/data/nginx/html</td></tr><tr><td>日志目录</td><td>/etc/nginx/nginx.conf</td><td>/data/nginx/conf/nginx.conf</td></tr><tr><td>nginx 配置文件目录</td><td>/var/log/nginx</td><td>/data/nginx/logs</td></tr><tr><td>证书存放目录</td><td>/etc/nginx/cert/</td><td>/data/nginx/cert</td></tr><tr><td>子配置项存放处</td><td>/etc/nginx/conf.d</td><td>/data/nginx/conf.d</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="225-创建挂载目录">2.2.5 创建挂载目录<a href="#225-创建挂载目录" class="hash-link" aria-label="2.2.5 创建挂载目录的直接链接" title="2.2.5 创建挂载目录的直接链接">​</a></h3>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /data/nginx/{conf,conf.d,html,logs,cert}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="226-复制配置到宿主机">2.2.6 复制配置到宿主机<a href="#226-复制配置到宿主机" class="hash-link" aria-label="2.2.6 复制配置到宿主机的直接链接" title="2.2.6 复制配置到宿主机的直接链接">​</a></h3>
<p>将 nginx 配置文件 copy 到宿主机中</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker cp nginx:/etc/nginx/nginx.conf /data/nginx/conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker cp nginx:/etc/nginx/conf.d /data/nginx/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker cp nginx:/usr/share/nginx/html/ /data/nginx/html/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker cp nginx:/var/log/nginx/ /data/nginx/logs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker cp nginx:/etc/nginx/cert/ /data/nginx/cert/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="227-停止并移除容器">2.2.7 停止并移除容器<a href="#227-停止并移除容器" class="hash-link" aria-label="2.2.7 停止并移除容器的直接链接" title="2.2.7 停止并移除容器的直接链接">​</a></h3>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker stop nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker rm nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="228-启动容器">2.2.8 启动容器<a href="#228-启动容器" class="hash-link" aria-label="2.2.8 启动容器的直接链接" title="2.2.8 启动容器的直接链接">​</a></h3>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker run -d \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --name nginx \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --restart=always \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -p 80:80 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -p 443:443 \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -v /data/nginx/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -v /data/nginx/html/:/usr/share/nginx/html/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -v /data/nginx/logs/:/var/log/nginx/ \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -v /data/nginx/conf.d/:/etc/nginx/conf.d \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           -v /data/nginx/cert/:/etc/nginx/cert \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           --privileged=true \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>3.重制 OnlyOffice 镜像</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-特殊需求">3.1 特殊需求<a href="#31-特殊需求" class="hash-link" aria-label="3.1 特殊需求的直接链接" title="3.1 特殊需求的直接链接">​</a></h2>
<p>目前 OnlyOffice 官方镜像并不能满足业务需求，考虑对官方镜像进行改造并重新提供适合需求的镜像，的需求目前收集到的如下:</p>
<p>1.需要适配<code>WOPI</code>协议(官方镜像默认不支持，需要修改镜像配置)</p>
<p>2.OnlyOffice 在线编辑器的 logo 字样为<code>ONLYOFFICE</code>，需要进行修改</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-docker-镜像安装">3.2 docker 镜像安装<a href="#32-docker-镜像安装" class="hash-link" aria-label="3.2 docker 镜像安装的直接链接" title="3.2 docker 镜像安装的直接链接">​</a></h2>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#1.查找镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker search onlyoffice/documentserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#2.下载镜像</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker pull onlyoffice/documentserver</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="33-重构-docker-镜像">3.3 重构 Docker 镜像<a href="#33-重构-docker-镜像" class="hash-link" aria-label="3.3 重构 Docker 镜像的直接链接" title="3.3 重构 Docker 镜像的直接链接">​</a></h2>
<p>以下为文件目录结构</p>
<p>├── Dockerfile
├── build-image.sh
├── header
│   ├── dark-logo_s.svg
│   ├── header-logo_s.svg
│   └── icons.svg
└── local.json</p>
<p>下面是相关文件及配置的一些说明</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="331-dockerfile">3.3.1 Dockerfile<a href="#331-dockerfile" class="hash-link" aria-label="3.3.1 Dockerfile的直接链接" title="3.3.1 Dockerfile的直接链接">​</a></h3>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#指定基础镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">FROM</span><span class="token instruction"> onlyoffice/documentserver:latest</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">LABEL</span><span class="token instruction"> maintainer = </span><span class="token instruction string" style="color:#e3116c">&quot;xxx@126.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">LABEL</span><span class="token instruction"> build_date = </span><span class="token instruction string" style="color:#e3116c">&quot;2023-05-25&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">LABEL</span><span class="token instruction"> comments = </span><span class="token instruction string" style="color:#e3116c">&quot;1.开启WOPI协议;2.更换编辑器logo&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#镜像操作指令安装vim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">RUN</span><span class="token instruction"> apt-get update</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">RUN</span><span class="token instruction"> apt-get install -y vim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#暴露程序端口80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">EXPOSE</span><span class="token instruction"> 80 443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#更换编辑器logo</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">COPY</span><span class="token instruction"> ./header /var/www/onlyoffice/documentserver/web-apps/apps/common/main/resources/img/header/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">COPY</span><span class="token instruction"> ./local.json /etc/onlyoffice/documentserver/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token instruction keyword" style="color:#00009f">ENTRYPOINT</span><span class="token instruction"> [</span><span class="token instruction string" style="color:#e3116c">&quot;/app/ds/run-document-server.sh&quot;</span><span class="token instruction">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="332-localjson">3.3.2 local.json<a href="#332-localjson" class="hash-link" aria-label="3.3.2 local.json的直接链接" title="3.3.2 local.json的直接链接">​</a></h3>
<p>local.json 文件为 OnlyOffice/documentserver 的容器配置，来源于容器内的 <code>/etc/onlyoffice/documentserver/local.json</code></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;services&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;CoAuthoring&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;sql&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;postgres&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;dbHost&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;dbPort&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;5432&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;dbName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;onlyoffice&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;dbUser&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;onlyoffice&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;dbPass&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;onlyoffice&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;enable&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;request&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;inbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;outbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;browser&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;inbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;header&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Authorization&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;inBody&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;outbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;header&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Authorization&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;inBody&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;secret&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;inbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;string&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;m0SnCOYxU9SoLOV2zGqKgiq6ARBBxc4i&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;outbox&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;string&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;m0SnCOYxU9SoLOV2zGqKgiq6ARBBxc4i&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;session&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;string&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;m0SnCOYxU9SoLOV2zGqKgiq6ARBBxc4i&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;rabbitmq&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;url&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;amqp://guest:guest@localhost&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;wopi&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;enable&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ipfilter&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;rules&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;address&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;*&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;allowed&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;useforrequest&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;errorcode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">403</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3321-开启-wopi-协议">3.3.2.1 开启 WOPI 协议<a href="#3321-开启-wopi-协议" class="hash-link" aria-label="3.3.2.1 开启 WOPI 协议的直接链接" title="3.3.2.1 开启 WOPI 协议的直接链接">​</a></h4>
<p>开启 WOPI 协议，需要修改 local.json，新增如下配置</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;wopi&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;enable&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;ipfilter&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;rules&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;address&quot;: &quot;*&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;allowed&quot;: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;useforrequest&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;errorcode&quot;: 403</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="333-header">3.3.3 header<a href="#333-header" class="hash-link" aria-label="3.3.3 header的直接链接" title="3.3.3 header的直接链接">​</a></h3>
<p>header 目录为 onlyoffice 编辑器样式中 logo 部分引用的图片，下边有 2 个文件<code>header-logo_s.svg</code>和<code>header-logo_s.svg</code>，为了实现对 logo 的自定义，需要修改这 2 个文件</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="334-build-imagesh">3.3.4 build-image.sh<a href="#334-build-imagesh" class="hash-link" aria-label="3.3.4 build-image.sh的直接链接" title="3.3.4 build-image.sh的直接链接">​</a></h3>
<p>按照 Dockerfile 重新构建镜像，镜像名称为<code>exfoide/onlyoffice:7.3.3</code>，其中<code>7.3.3</code>是<code>onlyoffce/documentserver</code>官方镜像的版本，表示<code>exfoide/onlyoffice:7.3.3</code>是基于<code>onlyoffce/documentserver:7.3.3</code>版本构建而成</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> build --no-cache </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> ./Dockerfile </span><span class="token parameter variable" style="color:#36acaa">-t</span><span class="token plain"> exfoide/onlyoffice:7.3.3 </span><span class="token builtin class-name">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>执行<code>build-image.sh</code>脚本后，docker 中新创建了容器:</p>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2023/png/22370594/1685000007506-2cbfc63a-39a2-4210-89b7-a63b2f4d9d1d.png" alt="image.png" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="34-替换-logo-方法参考">3.4 替换 logo 方法(参考)<a href="#34-替换-logo-方法参考" class="hash-link" aria-label="3.4 替换 logo 方法(参考)的直接链接" title="3.4 替换 logo 方法(参考)的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="341-将容器内的-logo-图片拷贝到本地">3.4.1 将容器内的 logo 图片拷贝到本地<a href="#341-将容器内的-logo-图片拷贝到本地" class="hash-link" aria-label="3.4.1 将容器内的 logo 图片拷贝到本地的直接链接" title="3.4.1 将容器内的 logo 图片拷贝到本地的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">docker</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">ps</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> onlyoffice/documentserver </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">:/var/www/onlyoffice/documentserver/web-apps/apps/common/main/resources/img/header ~/Desktop/header</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="342-修改-logo-图片">3.4.2 修改 logo 图片<a href="#342-修改-logo-图片" class="hash-link" aria-label="3.4.2 修改 logo 图片的直接链接" title="3.4.2 修改 logo 图片的直接链接">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="343-修改完成后将图片信息拷贝到容器">3.4.3 修改完成后将图片信息拷贝到容器<a href="#343-修改完成后将图片信息拷贝到容器" class="hash-link" aria-label="3.4.3 修改完成后将图片信息拷贝到容器的直接链接" title="3.4.3 修改完成后将图片信息拷贝到容器的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ~/Desktop/header </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">docker</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">ps</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> onlyoffice/documentserver </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain">:/var/www/onlyoffice/documentserver/web-apps/apps/common/main/resources/img/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>4.OnlyOffice 伪集群部署</h1>
<p>本例中准备 3 台服务器，机器环境如下</p>
<table><thead><tr><th><strong>服务器</strong></th><th><strong>ip</strong></th><th><strong>部署服务</strong></th><th>端口</th></tr></thead><tbody><tr><td>localhost</td><td>127.0.0.1</td><td>OnlyOffice</td><td>8091</td></tr><tr><td>localhost</td><td>127.0.0.1</td><td>OnlyOffice</td><td>8092</td></tr><tr><td>localhost</td><td>127.0.0.1</td><td>OnlyOffice</td><td>8093</td></tr><tr><td>localhost</td><td>127.0.0.1</td><td>nginx</td><td>80</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="41-安装-postgresql">4.1 安装 PostgreSQL<a href="#41-安装-postgresql" class="hash-link" aria-label="4.1 安装 PostgreSQL的直接链接" title="4.1 安装 PostgreSQL的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="411-获取镜像">4.1.1 获取镜像<a href="#411-获取镜像" class="hash-link" aria-label="4.1.1 获取镜像的直接链接" title="4.1.1 获取镜像的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> pull postgres</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="412-启动容器">4.1.2 启动容器<a href="#412-启动容器" class="hash-link" aria-label="4.1.2 启动容器的直接链接" title="4.1.2 启动容器的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> run </span><span class="token parameter variable" style="color:#36acaa">--name</span><span class="token plain"> postgres </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5432</span><span class="token plain">:5432 </span><span class="token parameter variable" style="color:#36acaa">-e</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">POSTGRES_PASSWORD</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--restart</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">always </span><span class="token parameter variable" style="color:#36acaa">-v</span><span class="token plain"> /data/postgres/data:/var/lib/postgresql/data </span><span class="token parameter variable" style="color:#36acaa">-d</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="42-准备-postgresql-数据库环境">4.2 准备 PostgreSQL 数据库环境<a href="#42-准备-postgresql-数据库环境" class="hash-link" aria-label="4.2 准备 PostgreSQL 数据库环境的直接链接" title="4.2 准备 PostgreSQL 数据库环境的直接链接">​</a></h2>
<p>通过 <code>&lt;&lt;**4.1安装PostgreSQL**&gt;&gt;</code> 已经安装了 PostgreSQL 数据库，接下来需要初始化 OnlyOffice 数据库及数据表</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="421-创建数据库">4.2.1 创建数据库<a href="#421-创建数据库" class="hash-link" aria-label="4.2.1 创建数据库的直接链接" title="4.2.1 创建数据库的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-it</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">docker</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">ps</span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">grep</span><span class="token variable" style="color:#36acaa"> postgres </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable function" style="color:#d73a49">awk</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable string" style="color:#e3116c">&#x27;{print $1}&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 连接数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql </span><span class="token parameter variable" style="color:#36acaa">-h</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1 </span><span class="token parameter variable" style="color:#36acaa">-U</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#Password for user postgres:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">输入: </span><span class="token number" style="color:#36acaa">123456</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#创建用户</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE </span><span class="token environment constant" style="color:#36acaa">USER</span><span class="token plain"> onlyoffice WITH PASSWORD </span><span class="token string" style="color:#e3116c">&#x27;onlyoffice&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#创建数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE DATABASE onlyoffice OWNER onlyoffice</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="422-创建数据表">4.2.2 创建数据表<a href="#422-创建数据表" class="hash-link" aria-label="4.2.2 创建数据表的直接链接" title="4.2.2 创建数据表的直接链接">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;doc_changes&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;tenant&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;change_id&quot;</span><span class="token plain"> int4 </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;user_id&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;user_id_original&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;user_name&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;change_data&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;change_date&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> without </span><span class="token keyword" style="color:#00009f">time</span><span class="token plain"> zone </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tenant&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;change_id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OIDS</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">FALSE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ----------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- Table structure for task_result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ----------------------------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;task_result&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;tenant&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;status&quot;</span><span class="token plain"> int2 </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;status_info&quot;</span><span class="token plain"> int4 </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;created_at&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> without </span><span class="token keyword" style="color:#00009f">time</span><span class="token plain"> zone </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NOW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;last_open_date&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> without </span><span class="token keyword" style="color:#00009f">time</span><span class="token plain"> zone </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;user_index&quot;</span><span class="token plain"> int4 </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;change_id&quot;</span><span class="token plain"> int4 </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;callback&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;baseurl&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;password&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;additional&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">text</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLLATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tenant&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">OIDS</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">FALSE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> merge_db</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_tenant </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _id </span><span class="token keyword" style="color:#00009f">varchar</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _status int2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _status_info int4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _last_open_date </span><span class="token keyword" style="color:#00009f">timestamp</span><span class="token plain"> without </span><span class="token keyword" style="color:#00009f">time</span><span class="token plain"> zone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _user_index int4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _change_id int4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _callback </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _baseurl </span><span class="token keyword" style="color:#00009f">text</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OUT</span><span class="token plain"> isupdate </span><span class="token keyword" style="color:#00009f">char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OUT</span><span class="token plain"> userindex int4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	t_var </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;task_result&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;user_index&quot;</span><span class="token operator" style="color:#393A34">%</span><span class="token keyword" style="color:#00009f">TYPE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">-- first try to update the key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">-- note that &quot;a&quot; must be unique</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_callback </span><span class="token operator" style="color:#393A34">&lt;&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_baseurl </span><span class="token operator" style="color:#393A34">&lt;&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">IS</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">TRUE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;task_result&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> last_open_date</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">_last_open_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user_index</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">user_index</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">callback</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">_callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">baseurl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">_baseurl </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tenant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _tenant </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _id </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> user_index </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> userindex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;task_result&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> last_open_date</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">_last_open_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user_index</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">user_index</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tenant </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _tenant </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _id </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> user_index </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> userindex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> found </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			isupdate :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;true&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">RETURN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">-- not there, so try to insert the key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">-- if someone else inserts the same key concurrently,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">-- we could get a unique-key failure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token string" style="color:#e3116c">&quot;task_result&quot;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tenant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> last_open_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user_index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> change_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> baseurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VALUES</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_tenant</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _status_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _last_open_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _user_index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _change_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _callback</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _baseurl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">RETURNING</span><span class="token plain"> user_index </span><span class="token keyword" style="color:#00009f">into</span><span class="token plain"> userindex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			isupdate :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;false&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">RETURN</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		EXCEPTION </span><span class="token keyword" style="color:#00009f">WHEN</span><span class="token plain"> unique_violation </span><span class="token keyword" style="color:#00009f">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">-- do nothing, and loop to try the UPDATE again</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="43-docker-compose-启动集群">4.3 Docker-compose 启动集群<a href="#43-docker-compose-启动集群" class="hash-link" aria-label="4.3 Docker-compose 启动集群的直接链接" title="4.3 Docker-compose 启动集群的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="431-安装-docker-compose">4.3.1 安装 Docker-compose<a href="#431-安装-docker-compose" class="hash-link" aria-label="4.3.1 安装 Docker-compose的直接链接" title="4.3.1 安装 Docker-compose的直接链接">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#从Docker官方网站下载Docker Compose最新版本的二进制文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://github.com/docker/compose/releases/latest/download/docker-compose-</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-s</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">-</span><span class="token string variable" style="color:#36acaa">$(</span><span class="token string variable function" style="color:#d73a49">uname</span><span class="token string variable" style="color:#36acaa"> </span><span class="token string variable parameter variable" style="color:#36acaa">-m</span><span class="token string variable" style="color:#36acaa">)</span><span class="token string" style="color:#e3116c">&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> /usr/bin/docker-compose</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#授予Docker Compose二进制文件执行权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chmod</span><span class="token plain"> +x /usr/bin/docker-compose </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="432-docker-compose-配置">4.3.2 Docker-Compose 配置<a href="#432-docker-compose-配置" class="hash-link" aria-label="4.3.2 Docker-Compose 配置的直接链接" title="4.3.2 Docker-Compose 配置的直接链接">​</a></h3>
<p>以下为文件目录结构
├── .env
├── delete-container.sh
├── docker-compose.yml
└── start.sh
下面是相关文件及配置的一些说明</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4321-env">4.3.2.1 .env<a href="#4321-env" class="hash-link" aria-label="4.3.2.1 .env的直接链接" title="4.3.2.1 .env的直接链接">​</a></h4>
<p>指定 docker-compose 文件中的环境变量</p>
<div class="language-.env codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-.env codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#指定数据库</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DB_TYPE=postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#数据库ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DB_HOST=127.0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">JWT_ENABLED=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#onlyoffice容器挂载到本地的目录</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MAPPING_LOCAL_DIR=/data/onlyoffice</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4322-docker-composeyml">4.3.2.2 docker-compose.yml<a href="#4322-docker-composeyml" class="hash-link" aria-label="4.3.2.2 docker-compose.yml的直接链接" title="4.3.2.2 docker-compose.yml的直接链接">​</a></h4>
<p>指定启动 3 个 onlyoffice 实例<!-- -->:onlyoffice-8091<!-- -->、onlyoffice-8092、onlyoffice-8093</p>
<div class="language-dockerfile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-dockerfile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">version: &#x27;3&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onlyoffice-8091:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context: .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dockerfile: ../docker-build/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: exfoide/onlyoffice:7.3.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container_name: onlyoffice-8091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_TYPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_HOST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_PORT=5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_NAME=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_USER=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Uncomment strings below to enable the JSON Web Token validation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - JWT_ENABLED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_SECRET=secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_HEADER=Authorization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_IN_BODY=true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - &#x27;8091:80&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdin_open: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    restart: always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stop_grace_period: 60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/logs:/var/log/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/data:/var/www/onlyoffice/Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/lib:/var/lib/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/db:/var/lib/postgresql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/cache/files:/var/lib/onlyoffice/documentserver/App_Data/cache/files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - /usr/share/fonts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privileged: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onlyoffice-8092:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context: .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dockerfile: ../docker-build/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: exfoide/onlyoffice:7.3.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container_name: onlyoffice-8092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_TYPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_HOST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_PORT=5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_NAME=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_USER=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Uncomment strings below to enable the JSON Web Token validation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - JWT_ENABLED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_SECRET=secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_HEADER=Authorization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_IN_BODY=true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - &#x27;8092:80&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdin_open: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    restart: always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stop_grace_period: 60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/logs:/var/log/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/data:/var/www/onlyoffice/Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/lib:/var/lib/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/db:/var/lib/postgresql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/cache/files:/var/lib/onlyoffice/documentserver/App_Data/cache/files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - /usr/share/fonts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privileged: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  onlyoffice-8093:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    build:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      context: .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dockerfile: ../docker-build/Dockerfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image: exfoide/onlyoffice:7.3.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container_name: onlyoffice-8093</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    environment:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_TYPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_HOST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_PORT=5432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_NAME=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - DB_USER=onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Uncomment strings below to enable the JSON Web Token validation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - JWT_ENABLED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_SECRET=secret</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_HEADER=Authorization</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">#- JWT_IN_BODY=true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - &#x27;8093:80&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stdin_open: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    restart: always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stop_grace_period: 60s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/logs:/var/log/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/data:/var/www/onlyoffice/Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/lib:/var/lib/onlyoffice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/db:/var/lib/postgresql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - ${MAPPING_LOCAL_DIR}/DocumentServer/cache/files:/var/lib/onlyoffice/documentserver/App_Data/cache/files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - /usr/share/fonts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    privileged: true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4323-startsh">4.3.2.3 start.sh<a href="#4323-startsh" class="hash-link" aria-label="4.3.2.3 start.sh的直接链接" title="4.3.2.3 start.sh的直接链接">​</a></h4>
<p>通过 docker-compose 启动集群容器</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker-compose</span><span class="token plain"> down  --remove-orphans</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker-compose</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> onlyoffice </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> ./docker-compose.yml up </span><span class="token parameter variable" style="color:#36acaa">-d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4324-delete-containersh">4.3.2.4 delete-container.sh<a href="#4324-delete-containersh" class="hash-link" aria-label="4.3.2.4 delete-container.sh的直接链接" title="4.3.2.4 delete-container.sh的直接链接">​</a></h4>
<p>通过 docker-compose 停止并删除集群容器</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">docker-compose</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> onlyoffice down --remove-orphans</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="433-启动集群">4.3.3 启动集群<a href="#433-启动集群" class="hash-link" aria-label="4.3.3 启动集群的直接链接" title="4.3.3 启动集群的直接链接">​</a></h3>
<p>执行 start.sh 启动 3 个 OnlyOffice 实例</p>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2023/png/22370594/1685002964009-e822b725-6ff3-48fe-b5be-7ad0d179d1c5.png" alt="image.png" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="44-部署-ngnix">4.4 部署 ngnix<a href="#44-部署-ngnix" class="hash-link" aria-label="4.4 部署 ngnix的直接链接" title="4.4 部署 ngnix的直接链接">​</a></h2>
<p>参照本文目录 1.2 安装 nginx</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="441-配置负载配置">4.4.1 配置负载配置<a href="#441-配置负载配置" class="hash-link" aria-label="4.4.1 配置负载配置的直接链接" title="4.4.1 配置负载配置的直接链接">​</a></h3>
<p>配置 nginx 负载</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /data/nginx/conf.d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">touch</span><span class="token plain"> office.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vi</span><span class="token plain"> office.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>文件内容</p>
<div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">upstream office {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hash $remote_addr consistent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 127.0.0.1:8091;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 127.0.0.1:8092;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server 127.0.0.1:8093;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen       80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen  [::]:80;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name  localhost;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #access_log  /var/log/nginx/host.access.log  main;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_pass http://office;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header X-Real-IP $remote_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header Host $http_host;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header X-Nginx-Proxy true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # WebSocker配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_http_version 1.1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header Upgrade $http_upgrade;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        proxy_set_header Connection &quot;upgrade&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # 显示具体负载的机器的ip,X-Route-Ip随便命名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add_header X-Route-Ip $upstream_addr;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        add_header X-Route-Status $upstream_status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>5.OnlyOffice 集成 WOPI 协议</h1>
<p>官方文档: <a href="https://api.onlyoffice.com/zh/editors/wopi/" target="_blank" rel="noopener noreferrer">https://api.onlyoffice.com/zh/editors/wopi/</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="51-wopi-协议集成">5.1 WOPI 协议集成<a href="#51-wopi-协议集成" class="hash-link" aria-label="5.1 WOPI 协议集成的直接链接" title="5.1 WOPI 协议集成的直接链接">​</a></h2>
<p>通过<code>**4.OnlyOffice伪集群部署**</code>我们已经部署了 3 个 OnlyOffice 实例的集群，并且已经开启了 WOPI 协议</p>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2023/png/22370594/1685154630255-ef36d531-a51f-4720-aa76-c333643f048d.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0" alt="image.png" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="52-wopi-协议交互流程">5.2 WOPI 协议交互流程<a href="#52-wopi-协议交互流程" class="hash-link" aria-label="5.2 WOPI 协议交互流程的直接链接" title="5.2 WOPI 协议交互流程的直接链接">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://cdn.nlark.com/yuque/0/2023/jpeg/22370594/1684546162673-72f1dd88-b451-4b60-821e-5fb1e6a5f0f1.jpeg" alt="img" class="img_ev3q"></p>
<ol>
<li>浏览器请求编辑或查看 Office 文件</li>
<li>WOPI Host 服务返回调用 wopi 所需的信息，如<a href="http://127.0.0.1/hosting/wopi/cell/edit?WOPISrc=http://127.0.0.1:8099/api/wopi/files/%E4%BA%A7%E5%93%81%E4%B8%AD%E5%BF%83%E5%91%A8%E6%8A%A520230503.xlsx" target="_blank" rel="noopener noreferrer">http://127.0.0.1/hosting/wopi/cell/edit?WOPISrc=http://127.0.0.1:8099/api/wopi/files/%E4%BA%A7%E5%93%81%E4%B8%AD%E5%BF%83%E5%91%A8%E6%8A%A520230503.xlsx</a>, 其中<a href="http://127.0.0.1/hosting/wopi/cell/edit" target="_blank" rel="noopener noreferrer">http://127.0.0.1/hosting/wopi/cell/edit</a> 表示需要通过 wopi 协议对 excel 类文件做编辑操作,</li>
</ol>
<p>WOPISrc=<a href="http://127.0.0.1:8099/api/wopi/files/%E4%BA%A7%E5%93%81%E4%B8%AD%E5%BF%83%E5%91%A8%E6%8A%A520230503.xlsx" target="_blank" rel="noopener noreferrer">http://127.0.0.1:8099/api/wopi/files/%E4%BA%A7%E5%93%81%E4%B8%AD%E5%BF%83%E5%91%A8%E6%8A%A520230503.xlsx</a> 表示编辑器中需要展示的文件链接</p>
<ol>
<li>浏览器请求 OnlyOffice 文档服务对文件进行操作</li>
<li>OnlyOffice 文档服务请求 WOPI Host 服务查询文件信息，调用的 WOPI 协议接口为:<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/checkfileinfo" target="_blank" rel="noopener noreferrer">CheckFileInfo</a></li>
<li>WOPI Host 返回文件名称、大小、是否能修改、是否支持锁等信息</li>
<li>OnlyOffice 文档服务请求 WOPI Host 服务查询文件信息，调用的 WOPI 协议接口为:<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/getfile" target="_blank" rel="noopener noreferrer">GetFile</a></li>
<li>WOPI Host 返回二进制格式的完整文件内容</li>
<li>OnlyOffice 文档服务将文件内容转换为 Office Open XML 格式, 返回给 js 编辑器, js 编辑器渲染 Office 文档内容</li>
<li>用户在 js 编辑器对文档进行编辑等操作，在编辑过程中会调用一些 WOPI 协议接口，如<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/lock" target="_blank" rel="noopener noreferrer">Lock</a>, <a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/unlock" target="_blank" rel="noopener noreferrer">UnLock</a>, <a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/refreshlock" target="_blank" rel="noopener noreferrer">RefreshLock</a>等</li>
<li>用户编辑完成，保存文档</li>
<li>OnlyOffice 文档服务请求更新文件内容，调用的 WOPI 协议接口为:<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi/putfile" target="_blank" rel="noopener noreferrer">PutFile</a></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="521-协议核心理解">5.2.1 协议核心理解<a href="#521-协议核心理解" class="hash-link" aria-label="5.2.1 协议核心理解的直接链接" title="5.2.1 协议核心理解的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5211-认证阶段">5.2.1.1 认证阶段<a href="#5211-认证阶段" class="hash-link" aria-label="5.2.1.1 认证阶段的直接链接" title="5.2.1.1 认证阶段的直接链接">​</a></h4>
<p>该阶段上面的交互流程图中的 step1、2 步骤，需要 Server 事先提供 Host 页面，用户通过 Browser 请求 Host 页面(用户感知到的只有 Host 页面，而不是 Office 页面)，Server 内部生成两个重要信息：</p>
<ul>
<li>文档唯一 ID：fileId</li>
<li>认证信息：access_token、access_token_ttl 然后内部通过调用/hosting/discovery 接口，返回一个可以访问 Office 服务的 urlsrc。具体交互时序图如下：</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/baf9a4bd5745440ab20833f3681d7769~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt="img" class="img_ev3q"></p>
<p>为何 Browser 不能跳过第 1、2 两步，直接进入 Step3 通过 URL 访问 Office 页面，这样 Office 客户端根据 WOPISrc 地址去 Server 执行 file 操作？理论上这样交互是可行，但是这么做相当于 Server 文档对任何外部请求都是可访问的，这对 Server 方是不能接受的，除非 Server 方信任并知道 Client 的地址情况下通过 IP 白名单机制来限制，但这样导致 Server 和 Client 存在耦合关系。</p>
<p>步骤 1、2 就是从 Server 获取文档权限信息，这样保护文件安全。Server 在页面初始化时生成 access_token，access_token 看成是一个认证凭证，代表用户是否有权访问文档：</p>
<ul>
<li>生成好的 access_token 返回给 Browser，也就是上图 step2 返回内容之一</li>
<li>然后接下来 Browser 向 Client 发出的请求带上 access_token，即 step3 发出的请求</li>
<li>Client 收到后在后续和 Server 交互时，会原样在请求 URL 参数里带上 access_token，这样 Server 会先校验请求携带的 access_token 是否合法，如果是说明 Office 有权限打开文档</li>
</ul>
<p>这个过程可以总结为 Client 和 Server 通过 Browser 这个中介来传递 access_token。当然 access_token 值并不是一直有效，WOPI 协议规定 Server 设置 access_token_ttl，用来通知 Client 关于 access_token 值的有效期，默认是 10h，超过这个时间后 Client 会取消本次会话。</p>
<p>注意：step3 中 access_token 是怎么传递给 Server？如果开始时直接在 URL 参数里携带，URL 在公网传输，就有提前泄漏 access_token 的风险，也就是说 Browser 不能主动在 URL 里写入 access_token，但是 Client 是可以的，因为 access_token 有效性是由 Server 决定，Client 只管在请求里原样返回并由 Server 校验。所以 WOPI 协议的 demo 建议 step3 通过 POST 方法访问 Office 平台，access_token 通过表单提交，这样在 https 传输协议下 access_token 传输至少是安全的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5212-文档打开和编辑保存">5.2.1.2 文档打开和编辑保存<a href="#5212-文档打开和编辑保存" class="hash-link" aria-label="5.2.1.2 文档打开和编辑保存的直接链接" title="5.2.1.2 文档打开和编辑保存的直接链接">​</a></h4>
<p>从文档生命周期来看，文档操作包括打开、查看/编辑和保存流程。</p>
<p>查看和编辑是 Office 平台能力，打开文档请求 Server 获取文档内容，编辑文档后关闭页面，通知 Server 保存文档最新内容。WOPI 协议定义了文件操作接口，其中 CheckFileInfo、GetFile、PutFile 接口实现上述打开和保存文件功能， GetFile、PutFile 比较好理解，CheckFileInfo 接口功能比较复杂，但是它决定 Client 端对文档的 UI 展示行为和后续允许的操作，这是由 Server 端提供属性信息决定，该接口返回包括：</p>
<ul>
<li>
<p>文件基本信息：比如大小、文件展示名字等，</p>
</li>
<li>
<p>用户权限属性，常见属性包括：</p>
</li>
<li>
<ul>
<li>UserCanWrite：指示当前请求用户是否有权限更改文件，这决定 Client 后续是否允许调用 PutFile 接口</li>
</ul>
</li>
<li>
<p>ReadOnly：文档是否只读</p>
</li>
<li>
<p>UserCanRename：文档是否允许重命名，为 false 时 Client 在 UI 展示时不会提供重命名按钮</p>
</li>
<li>
<p>指示 Client，Server 支持哪些功能属性（capabilities properties），列举几个常见属性</p>
</li>
<li>
<ul>
<li>SupportsGetLock：为 true 说明 Server 支持 GetLock 操作</li>
</ul>
</li>
<li>
<p>SupportsLocks：为 true 说明 Server 端支持 Lock、Unlock 等操作，Lock 相关语义方面会提到</p>
</li>
<li>
<p>SupportsRename：为 true 说明 Server 端支持对文档重命名操作</p>
</li>
<li>
<p>SupportsUpdate：为 true，说明 Server 支持更新文档操作 Server 通知 Client 后，Client 就可以在 Server 提供的属性决定后续操作是否允许调用，比如假设 Server 端通过 checkFileInfo 接口设置 SupportsUpdate 为 false，那 Client 端知道 Server 不支持提供 PutFile 接口来更新文档，当文档关闭后 Client 不会把文档更新内容通知 Server 保存。</p>
</li>
</ul>
<p>这些权限属性和 access_token 有什么关系？事实上，access_token 充当对任何请求来源的认证机制，只有匹配 Server 端生成的值才是合法的，如果 Server 校验 access_token 不合法时，Client 发出的任何操作请求被拒绝；而上述权限属性是在请求被认证通过的基础上，用来限制用户在 Client 端的操作能力。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5213-锁机制">5.2.1.3 锁机制<a href="#5213-锁机制" class="hash-link" aria-label="5.2.1.3 锁机制的直接链接" title="5.2.1.3 锁机制的直接链接">​</a></h4>
<p>如果用户有权限编辑文档内容，Server 就要关心是否支持对文档的加解锁操作。锁的作用就像一把进入文档编辑的钥匙，只有拿到钥匙的合法用户才能编辑文档。锁机制判断文档是否允许多个用户同时编辑。</p>
<p>锁信息用锁 id（lockId）标识，lockId 的生命周期由 Client 负责控制，Server 存储指定文档的 lockId，在 Client 获取文档内容之前开始加锁，调用文档保存接口后解锁：</p>
<ul>
<li>加锁操作时 Client 向 Server 发出 lock 请求，lockId 放在请求头的 X-WOPI-Lock 字段中，Server 获取该字段值后，判断文档是否被加锁或者校验请求 lockId 和已有是否匹配，匹配才能允许 Client 获取文档内容。</li>
<li>解锁操作时 Client 向 Server 发出 unlock 请求，同样 Server 检查 lockId 是否匹配，匹配成功才能释放锁</li>
</ul>
<p>为何 lockId 还需要 Server 来存储，Server 没必要感知到锁的存在？上面提到 Server 通过 SupportsLocks 属性通知 Client 是否支持对文档加解锁，Server 虽然不负责 lockId 的生成，但是具体加解锁判断成功与否的策略由 Server 控制，举个例子，如果两个用户 A、B 操作同一个文档，A 先加锁拿到 lockID，B 后续通过 unlock 请求解锁表示要提前保存文档，并且解锁请求头携带的 lockId 和 A 相同，这种情况下 Client 无法判断是否允许这样操作，Client 生成的 lockId 和具体用户没有任何关联，只有 Server 有权决定不同用户拿到相同 lockId 时操作是否允许。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="522-组成部分">5.2.2 组成部分<a href="#522-组成部分" class="hash-link" aria-label="5.2.2 组成部分的直接链接" title="5.2.2 组成部分的直接链接">​</a></h3>
<p>按照 WOPI 协议交互流程图所示，整个 onlyoffice 集成过程中有 3 个角色，分别是:</p>
<ul>
<li>Web Office 编辑器: 通过 js 实现 office 编辑器，需要在浏览器中展现</li>
<li>WOPI 服务器(Host): 实现<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi" target="_blank" rel="noopener noreferrer">WOIPI REST API</a>的文件管理系统</li>
<li>WOPI 客户端(Client): 理解为提供 Office 查看和编辑能力的平台，比如前面安装的 Onlyoffice</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5221-web-office-编辑器集成">5.2.2.1 Web Office 编辑器集成<a href="#5221-web-office-编辑器集成" class="hash-link" aria-label="5.2.2.1 Web Office 编辑器集成的直接链接" title="5.2.2.1 Web Office 编辑器集成的直接链接">​</a></h4>
<p>Web Office 编辑器需要一个前端页面来承载，传送门<a href="https://api.onlyoffice.com/zh/editors/wopi/hostpage" target="_blank" rel="noopener noreferrer">主机页面</a></p>
<p>其中 actionUrl、token、tokenTtl 需要传入，actionUrl 指定需要 Office 编辑器执行的操作</p>
<p>举例如下:</p>
<p><code>http:{documentserverIP}/hosting/wopi/:documentType/:mode?WOPISrc=http://serverHost/wopi/files/:fileId</code>：根据指定文档 fileId，返回用户可以查看或者编辑文档的 HTML 内容，渲染器最终渲染该页面，域名和路径就是/hosting/discovery 接口返回的 urlsrc，其中</p>
<ul>
<li>documentserverIP 表示部署 only office/documentserver 服务的地址</li>
<li>documentType 表示文档类型，包括 xlsx、docx 等</li>
<li>mode 表示查看或者编辑模式，包括 show、edit。上图中 step3 通过该接口访问 Office Client 服务</li>
<li>WOPISrc：协议约定的一个 URL，需要 Server 提供，Browser 根据该信息通知 Client 可以对 Office 文档执行 WOPI 规定的文档操作</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5222-wopi-服务器host">5.2.2.2 WOPI 服务器(Host):<a href="#5222-wopi-服务器host" class="hash-link" aria-label="5.2.2.2 WOPI 服务器(Host):的直接链接" title="5.2.2.2 WOPI 服务器(Host):的直接链接">​</a></h4>
<p>实现了<a href="https://api.onlyoffice.com/zh/editors/wopi/restapi" target="_blank" rel="noopener noreferrer">WOPI Rest Api</a>的后端应用，需要实现对文件的查看、下载、锁定等 api 接口。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5223-wopi-客户端client">5.2.2.3 WOPI 客户端(Client)<a href="#5223-wopi-客户端client" class="hash-link" aria-label="5.2.2.3 WOPI 客户端(Client)的直接链接" title="5.2.2.3 WOPI 客户端(Client)的直接链接">​</a></h4>
<p>理解为提供 Office 查看和编辑能力的平台，比如前面安装的 onlyoffice/documentserver 等，之前的步骤中已经安装好了 onlyoffice/documentserver，并且开启了 wopi 协议，Client 的所有配置及开发工作已经完成，后续操作中需要确保 onlyoffice/documentserver 保持运行</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>标签：</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/docker">Docker</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/cloud-native">CloudNative</a></li></ul></div></div><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/Docker/Docker构建OnlyOffice集群.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/cloud-native/docker/build-elk"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Docker 构建 ELK</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/cloud-native/docker/build-jenkins"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Docker 构建 Jenkins</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11-onlyoffice-优点" class="table-of-contents__link toc-highlight">1.1 onlyOffice 优点</a></li><li><a href="#12-onlyoffice-项目信息" class="table-of-contents__link toc-highlight">1.2 OnlyOffice 项目信息</a></li><li><a href="#21-安装-docker" class="table-of-contents__link toc-highlight">2.1 安装 Docker</a><ul><li><a href="#211-安装-docker" class="table-of-contents__link toc-highlight">2.1.1 安装 Docker</a></li><li><a href="#212-检测-docker-是否安装成功" class="table-of-contents__link toc-highlight">2.1.2 检测 Docker 是否安装成功</a></li><li><a href="#213-设置-docker-开机启动" class="table-of-contents__link toc-highlight">2.1.3 设置 docker 开机启动</a></li><li><a href="#214-设置-docker-镜像源" class="table-of-contents__link toc-highlight">2.1.4 设置 docker 镜像源</a></li></ul></li><li><a href="#22-安装-nginx" class="table-of-contents__link toc-highlight">2.2 安装 nginx</a><ul><li><a href="#221-docker-安装-nginx" class="table-of-contents__link toc-highlight">2.2.1 docker 安装 nginx</a></li><li><a href="#222-nginx-服务配置及启动" class="table-of-contents__link toc-highlight">2.2.2 nginx 服务配置及启动</a></li><li><a href="#223-启动容器" class="table-of-contents__link toc-highlight">2.2.3 启动容器</a></li><li><a href="#224-目录映射" class="table-of-contents__link toc-highlight">2.2.4 目录映射</a></li><li><a href="#225-创建挂载目录" class="table-of-contents__link toc-highlight">2.2.5 创建挂载目录</a></li><li><a href="#226-复制配置到宿主机" class="table-of-contents__link toc-highlight">2.2.6 复制配置到宿主机</a></li><li><a href="#227-停止并移除容器" class="table-of-contents__link toc-highlight">2.2.7 停止并移除容器</a></li><li><a href="#228-启动容器" class="table-of-contents__link toc-highlight">2.2.8 启动容器</a></li></ul></li><li><a href="#31-特殊需求" class="table-of-contents__link toc-highlight">3.1 特殊需求</a></li><li><a href="#32-docker-镜像安装" class="table-of-contents__link toc-highlight">3.2 docker 镜像安装</a></li><li><a href="#33-重构-docker-镜像" class="table-of-contents__link toc-highlight">3.3 重构 Docker 镜像</a><ul><li><a href="#331-dockerfile" class="table-of-contents__link toc-highlight">3.3.1 Dockerfile</a></li><li><a href="#332-localjson" class="table-of-contents__link toc-highlight">3.3.2 local.json</a><ul><li><a href="#3321-开启-wopi-协议" class="table-of-contents__link toc-highlight">3.3.2.1 开启 WOPI 协议</a></li></ul></li><li><a href="#333-header" class="table-of-contents__link toc-highlight">3.3.3 header</a></li><li><a href="#334-build-imagesh" class="table-of-contents__link toc-highlight">3.3.4 build-image.sh</a></li></ul></li><li><a href="#34-替换-logo-方法参考" class="table-of-contents__link toc-highlight">3.4 替换 logo 方法(参考)</a><ul><li><a href="#341-将容器内的-logo-图片拷贝到本地" class="table-of-contents__link toc-highlight">3.4.1 将容器内的 logo 图片拷贝到本地</a></li><li><a href="#342-修改-logo-图片" class="table-of-contents__link toc-highlight">3.4.2 修改 logo 图片</a></li><li><a href="#343-修改完成后将图片信息拷贝到容器" class="table-of-contents__link toc-highlight">3.4.3 修改完成后将图片信息拷贝到容器</a></li></ul></li><li><a href="#41-安装-postgresql" class="table-of-contents__link toc-highlight">4.1 安装 PostgreSQL</a><ul><li><a href="#411-获取镜像" class="table-of-contents__link toc-highlight">4.1.1 获取镜像</a></li><li><a href="#412-启动容器" class="table-of-contents__link toc-highlight">4.1.2 启动容器</a></li></ul></li><li><a href="#42-准备-postgresql-数据库环境" class="table-of-contents__link toc-highlight">4.2 准备 PostgreSQL 数据库环境</a><ul><li><a href="#421-创建数据库" class="table-of-contents__link toc-highlight">4.2.1 创建数据库</a></li><li><a href="#422-创建数据表" class="table-of-contents__link toc-highlight">4.2.2 创建数据表</a></li></ul></li><li><a href="#43-docker-compose-启动集群" class="table-of-contents__link toc-highlight">4.3 Docker-compose 启动集群</a><ul><li><a href="#431-安装-docker-compose" class="table-of-contents__link toc-highlight">4.3.1 安装 Docker-compose</a></li><li><a href="#432-docker-compose-配置" class="table-of-contents__link toc-highlight">4.3.2 Docker-Compose 配置</a><ul><li><a href="#4321-env" class="table-of-contents__link toc-highlight">4.3.2.1 .env</a></li><li><a href="#4322-docker-composeyml" class="table-of-contents__link toc-highlight">4.3.2.2 docker-compose.yml</a></li><li><a href="#4323-startsh" class="table-of-contents__link toc-highlight">4.3.2.3 start.sh</a></li><li><a href="#4324-delete-containersh" class="table-of-contents__link toc-highlight">4.3.2.4 delete-container.sh</a></li></ul></li><li><a href="#433-启动集群" class="table-of-contents__link toc-highlight">4.3.3 启动集群</a></li></ul></li><li><a href="#44-部署-ngnix" class="table-of-contents__link toc-highlight">4.4 部署 ngnix</a><ul><li><a href="#441-配置负载配置" class="table-of-contents__link toc-highlight">4.4.1 配置负载配置</a></li></ul></li><li><a href="#51-wopi-协议集成" class="table-of-contents__link toc-highlight">5.1 WOPI 协议集成</a></li><li><a href="#52-wopi-协议交互流程" class="table-of-contents__link toc-highlight">5.2 WOPI 协议交互流程</a><ul><li><a href="#521-协议核心理解" class="table-of-contents__link toc-highlight">5.2.1 协议核心理解</a><ul><li><a href="#5211-认证阶段" class="table-of-contents__link toc-highlight">5.2.1.1 认证阶段</a></li><li><a href="#5212-文档打开和编辑保存" class="table-of-contents__link toc-highlight">5.2.1.2 文档打开和编辑保存</a></li><li><a href="#5213-锁机制" class="table-of-contents__link toc-highlight">5.2.1.3 锁机制</a></li></ul></li><li><a href="#522-组成部分" class="table-of-contents__link toc-highlight">5.2.2 组成部分</a><ul><li><a href="#5221-web-office-编辑器集成" class="table-of-contents__link toc-highlight">5.2.2.1 Web Office 编辑器集成</a></li><li><a href="#5222-wopi-服务器host" class="table-of-contents__link toc-highlight">5.2.2.2 WOPI 服务器(Host):</a></li><li><a href="#5223-wopi-客户端client" class="table-of-contents__link toc-highlight">5.2.2.3 WOPI 客户端(Client)</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/Tutorial/React Native跨端开发环境的副本/React Native跨端开发环境">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ilcb" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 DocHub, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>