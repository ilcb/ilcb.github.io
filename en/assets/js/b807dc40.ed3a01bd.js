"use strict";(self.webpackChunkdoc_hub=self.webpackChunkdoc_hub||[]).push([[57],{28453:(e,n,r)=>{r.d(n,{R:()=>s,x:()=>o});var a=r(96540);const l={},t=a.createContext(l);function s(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),a.createElement(t.Provider,{value:n},e.children)}},84487:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>i});const a=JSON.parse('{"id":"CloudNative/Docker/Docker\u6784\u5efaPrometheus","title":"Docker \u6784\u5efa Prometheus","description":"Docker \u6784\u5efa Prometheus","source":"@site/docs/CloudNative/Docker/Docker\u6784\u5efaPrometheus.md","sourceDirName":"CloudNative/Docker","slug":"/cloud-native/docker/build-prometheus","permalink":"/en/docs/cloud-native/docker/build-prometheus","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/CloudNative/Docker/Docker\u6784\u5efaPrometheus.md","tags":[{"inline":true,"label":"Docker","permalink":"/en/docs/tags/docker"},{"inline":true,"label":"CloudNative","permalink":"/en/docs/tags/cloud-native"}],"version":"current","frontMatter":{"title":"Docker \u6784\u5efa Prometheus","description":"Docker \u6784\u5efa Prometheus","slug":"/cloud-native/docker/build-prometheus","hide_table_of_contents":false,"keywords":["Docker"],"tags":["Docker","CloudNative"],"date":"2017-08-01T00:00:00.000Z","categories":["Docker"]},"sidebar":"dockerSidebar","previous":{"title":"Docker \u6784\u5efa PostgreSQL","permalink":"/en/docs/cloud-native/docker/build-postgresql"},"next":{"title":"Docker \u6784\u5efa ELK","permalink":"/en/docs/cloud-native/docker/build-elk"}}');var l=r(74848),t=r(28453);const s={title:"Docker \u6784\u5efa Prometheus",description:"Docker \u6784\u5efa Prometheus",slug:"/cloud-native/docker/build-prometheus",hide_table_of_contents:!1,keywords:["Docker"],tags:["Docker","CloudNative"],date:new Date("2017-08-01T00:00:00.000Z"),categories:["Docker"]},o="\u5b89\u88c5 Prometheus",c={},i=[{value:"1.1 \u7b80\u4ecb",id:"11-\u7b80\u4ecb",level:2},{value:"1.2 \u4ec0\u4e48\u662f\u6307\u6807",id:"12-\u4ec0\u4e48\u662f\u6307\u6807",level:2},{value:"1.3 \u7ec4\u4ef6\u6982\u8ff0",id:"13-\u7ec4\u4ef6\u6982\u8ff0",level:2},{value:"1.3.1 Prometheus Server",id:"131-prometheus-server",level:3},{value:"1.3.2 Node-Exporter",id:"132-node-exporter",level:3},{value:"1.3.3 Grafana",id:"133-grafana",level:3},{value:"1.3.4 AlertManager",id:"134-alertmanager",level:3},{value:"1.3.5 Push Gateway",id:"135-push-gateway",level:3},{value:"1.4 Prometheus \u5de5\u4f5c\u6d41\u7a0b",id:"14-prometheus-\u5de5\u4f5c\u6d41\u7a0b",level:2},{value:"1.4.1 \u6307\u6807\u91c7\u96c6",id:"141-\u6307\u6807\u91c7\u96c6",level:3},{value:"1.4.2 \u6307\u6807\u5904\u7406",id:"142-\u6307\u6807\u5904\u7406",level:3},{value:"1.4.3 \u6307\u6807\u5c55\u793a",id:"143-\u6307\u6807\u5c55\u793a",level:3},{value:"1.4.4 \u6307\u6807\u544a\u8b66",id:"144-\u6307\u6807\u544a\u8b66",level:3},{value:"1.5 Prometheus \u6307\u6807\u5206\u7c7b",id:"15-prometheus-\u6307\u6807\u5206\u7c7b",level:2},{value:"1.5.1 Counter",id:"151-counter",level:3},{value:"1.5.2 Gauge",id:"152-gauge",level:3},{value:"1.5.3 Summary",id:"153-summary",level:3},{value:"2.1 \u83b7\u53d6\u955c\u50cf",id:"21-\u83b7\u53d6\u955c\u50cf",level:3},{value:"2.2 \u521b\u5efa\u6301\u4e45\u5316\u8def\u5f84",id:"22-\u521b\u5efa\u6301\u4e45\u5316\u8def\u5f84",level:3},{value:"2.3 \u5199\u4e3b\u914d\u7f6e\u6587\u4ef6",id:"23-\u5199\u4e3b\u914d\u7f6e\u6587\u4ef6",level:3},{value:"2.4 \u521b\u5efa rule \u544a\u8b66\u9608\u503c",id:"24-\u521b\u5efa-rule-\u544a\u8b66\u9608\u503c",level:3},{value:"2.5 \u8fd0\u884c\u5bb9\u5668",id:"25-\u8fd0\u884c\u5bb9\u5668",level:3},{value:"2.6 \u67e5\u770b\u4e3b\u670d\u52a1\u90e8\u7f72\u72b6\u51b5",id:"26-\u67e5\u770b\u4e3b\u670d\u52a1\u90e8\u7f72\u72b6\u51b5",level:3},{value:"3.1 \u83b7\u53d6\u955c\u50cf",id:"31-\u83b7\u53d6\u955c\u50cf",level:3},{value:"3.2 \u542f\u52a8\u5bb9\u5668",id:"32-\u542f\u52a8\u5bb9\u5668",level:3},{value:"3.3 \u67e5\u770b",id:"33-\u67e5\u770b",level:3},{value:"4.1 \u83b7\u53d6\u955c\u50cf",id:"41-\u83b7\u53d6\u955c\u50cf",level:3},{value:"4.2 \u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",id:"42-\u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",level:3},{value:"4.3 \u544a\u8b66\u90ae\u4ef6\u914d\u7f6e",id:"43-\u544a\u8b66\u90ae\u4ef6\u914d\u7f6e",level:3},{value:"4.4 \u51c6\u5907\u9884\u8b66\u5185\u5bb9\u6a21\u677f\u6587\u4ef6",id:"44-\u51c6\u5907\u9884\u8b66\u5185\u5bb9\u6a21\u677f\u6587\u4ef6",level:3},{value:"4.5 \u542f\u52a8\u5bb9\u5668",id:"45-\u542f\u52a8\u5bb9\u5668",level:3},{value:"4.6 \u67e5\u770b\u5e76\u7b49\u5f85\u544a\u8b66",id:"46-\u67e5\u770b\u5e76\u7b49\u5f85\u544a\u8b66",level:3},{value:"5.1 \u83b7\u53d6\u955c\u50cf",id:"51-\u83b7\u53d6\u955c\u50cf",level:3},{value:"5.2 \u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",id:"52-\u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",level:3},{value:"5.3 \u542f\u52a8\u5bb9\u5668",id:"53-\u542f\u52a8\u5bb9\u5668",level:3},{value:"6.1 .env",id:"61-env",level:2},{value:"6.2 docker-compose.yml",id:"62-docker-composeyml",level:2},{value:"6.3 start.sh",id:"63-startsh",level:2},{value:"6.4 delete-container.sh",id:"64-delete-containersh",level:2},{value:"7.1 \u8f6f\u4ef6\u5305",id:"71-\u8f6f\u4ef6\u5305",level:2},{value:"7.2 \u5b89\u88c5 oracle-instantclient",id:"72-\u5b89\u88c5-oracle-instantclient",level:2},{value:"7.2.1 \u521b\u5efa tnsname",id:"721-\u521b\u5efa-tnsname",level:3},{value:"7.2.2 \u914d\u7f6e oracle \u5ba2\u6237\u7aef\u73af\u5883\u53d8\u91cf",id:"722-\u914d\u7f6e-oracle-\u5ba2\u6237\u7aef\u73af\u5883\u53d8\u91cf",level:3},{value:"7.3 \u5b89\u88c5 oracledb_exporter",id:"73-\u5b89\u88c5-oracledb_exporter",level:2},{value:"7.3.1 \u89e3\u538b oracledb_exporter \u6267\u884c\u6587\u4ef6",id:"731-\u89e3\u538b-oracledb_exporter-\u6267\u884c\u6587\u4ef6",level:3},{value:"7.3.2 \u89e3\u538b oracledb_exporter \u6e90\u6587\u4ef6",id:"732-\u89e3\u538b-oracledb_exporter-\u6e90\u6587\u4ef6",level:3},{value:"7.3.3 \u521b\u5efa\u542f\u52a8\u811a\u672c",id:"733-\u521b\u5efa\u542f\u52a8\u811a\u672c",level:3},{value:"7.3.4 \u542f\u52a8 oracledb_exporter",id:"734-\u542f\u52a8-oracledb_exporter",level:3},{value:"7.3.5 \u786e\u8ba4\u542f\u52a8\u662f\u5426\u6210\u529f",id:"735-\u786e\u8ba4\u542f\u52a8\u662f\u5426\u6210\u529f",level:3},{value:"7.4 Prometheus \u96c6\u6210 oracledb_exporter",id:"74-prometheus-\u96c6\u6210-oracledb_exporter",level:2},{value:"7.4.1 \u914d\u7f6e\u76d1\u542c",id:"741-\u914d\u7f6e\u76d1\u542c",level:3},{value:"7.4.2 \u914d\u7f6e\u544a\u8b66\u89c4\u5219",id:"742-\u914d\u7f6e\u544a\u8b66\u89c4\u5219",level:3},{value:"8.1 \u90ae\u4ef6\u544a\u8b66",id:"81-\u90ae\u4ef6\u544a\u8b66",level:2},{value:"8.2 \u9489\u9489\u544a\u8b66",id:"82-\u9489\u9489\u544a\u8b66",level:2},{value:"8.2.1 \u6dfb\u52a0\u9489\u9489\u544a\u8b66\u673a\u5668\u4eba",id:"821-\u6dfb\u52a0\u9489\u9489\u544a\u8b66\u673a\u5668\u4eba",level:3},{value:"8.2.2 \u5b89\u88c5\u63d2\u4ef6",id:"822-\u5b89\u88c5\u63d2\u4ef6",level:3},{value:"8.2.2.1 \u4e0b\u8f7d\u63d2\u4ef6",id:"8221-\u4e0b\u8f7d\u63d2\u4ef6",level:4},{value:"8.2.2.2 \u5b89\u88c5",id:"8222-\u5b89\u88c5",level:4},{value:"8.2.2.3 \u4fee\u6539\u9489\u9489\u544a\u8b66\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6",id:"8223-\u4fee\u6539\u9489\u9489\u544a\u8b66\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6",level:4},{value:"8.2.2.4 \u4fee\u6539\u9489\u9489\u544a\u8b66\u6a21\u677f",id:"8224-\u4fee\u6539\u9489\u9489\u544a\u8b66\u6a21\u677f",level:4},{value:"8.2.2.5 \u542f\u52a8\u544a\u8b66\u63d2\u4ef6",id:"8225-\u542f\u52a8\u544a\u8b66\u63d2\u4ef6",level:4},{value:"8.2.2.6 \u4fee\u6539 alertManager \u544a\u8b66",id:"8226-\u4fee\u6539-alertmanager-\u544a\u8b66",level:4},{value:"8.2.2.7 \u91cd\u542f AlertManager",id:"8227-\u91cd\u542f-alertmanager",level:4},{value:"8.2.2.8 \u67e5\u770b\u544a\u8b66\u662f\u5426\u751f\u6210",id:"8228-\u67e5\u770b\u544a\u8b66\u662f\u5426\u751f\u6210",level:4},{value:"8.2.2.9 \u9489\u9489\u544a\u8b66\u4fe1\u606f",id:"8229-\u9489\u9489\u544a\u8b66\u4fe1\u606f",level:4}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",img:"img",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"\u5b89\u88c5-prometheus",children:"\u5b89\u88c5 Prometheus"})}),"\n",(0,l.jsx)(n.h1,{id:"1-prometheus-\u4ecb\u7ecd",children:"1. Prometheus \u4ecb\u7ecd"}),"\n",(0,l.jsx)(n.h2,{id:"11-\u7b80\u4ecb",children:"1.1 \u7b80\u4ecb"}),"\n",(0,l.jsx)(n.p,{children:"\u666e\u7f57\u7c73\u4fee\u65af\u662f\u4e00\u4e2a\u5f00\u6e90\u7cfb\u7edf\uff0cPrometheus \u6536\u96c6\u5176\u6307\u6807\u5e76\u5c06\u5176\u5b58\u50a8\u4e3a\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0c\u5373\u6307\u6807\u4fe1\u606f\u4e0e\u8bb0\u5f55\u5b83\u7684\u65f6\u95f4\u6233\u4e00\u8d77\u5b58\u50a8\uff0c\u4ee5\u53ca\u79f0\u4e3a\u6807\u7b7e\u7684\u53ef\u9009\u952e\u503c\u5bf9"}),"\n",(0,l.jsx)(n.h2,{id:"12-\u4ec0\u4e48\u662f\u6307\u6807",children:"1.2 \u4ec0\u4e48\u662f\u6307\u6807"}),"\n",(0,l.jsx)(n.p,{children:"\u901a\u4fd7\u5730\u8bf4\uff0c\u6307\u6807\u662f\u6570\u5b57\u5ea6\u91cf\uff0c\u65f6\u95f4\u5e8f\u5217\u610f\u5473\u7740\u968f\u65f6\u95f4\u8bb0\u5f55\u66f4\u6539\uff0c\u7528\u6237\u60f3\u8981\u6d4b\u91cf\u7684\u5185\u5bb9\u56e0\u5e94\u7528\u7a0b\u5e8f\u800c\u5f02\u3002\u5bf9\u4e8e Web \u670d\u52a1\u5668\uff0c\u5b83\u53ef\u80fd\u662f\u8bf7\u6c42\u65f6\u95f4\uff0c\u5bf9\u4e8e\u6570\u636e\u5e93\uff0c\u5b83\u53ef\u80fd\u662f\u6d3b\u52a8\u8fde\u63a5\u6570\u6216\u6d3b\u52a8\u67e5\u8be2\u6570\u7b49\u3002"}),"\n",(0,l.jsx)(n.p,{children:"\u6307\u6807\u5728\u7406\u89e3\u5e94\u7528\u7a0b\u5e8f\u4ee5\u67d0\u79cd\u65b9\u5f0f\u5de5\u4f5c\u7684\u539f\u56e0\u65b9\u9762\u8d77\u7740\u91cd\u8981\u4f5c\u7528\u3002\u5047\u8bbe\u60a8\u6b63\u5728\u8fd0\u884c\u4e00\u4e2a Web \u5e94\u7528\u7a0b\u5e8f\uff0c\u53d1\u73b0\u8be5\u5e94\u7528\u7a0b\u5e8f\u5f88\u6162\uff0c\u60a8\u5c06\u9700\u8981\u4e00\u4e9b\u4fe1\u606f\u6765\u4e86\u89e3\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u53d1\u751f\u4e86\u4ec0\u4e48\u3002\u4f8b\u5982\uff0c\u5f53\u8bf7\u6c42\u6570\u5f88\u9ad8\u65f6\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u53d8\u6162\u3002\u5982\u679c\u60a8\u6709\u8bf7\u6c42\u8ba1\u6570\u6307\u6807\uff0c\u5219\u53ef\u4ee5\u627e\u51fa\u539f\u56e0\u5e76\u589e\u52a0\u5904\u7406\u8d1f\u8f7d\u7684\u670d\u52a1\u5668\u6570\u91cf\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"13-\u7ec4\u4ef6\u6982\u8ff0",children:"1.3 \u7ec4\u4ef6\u6982\u8ff0"}),"\n",(0,l.jsx)(n.h3,{id:"131-prometheus-server",children:"1.3.1 Prometheus Server"}),"\n",(0,l.jsx)(n.p,{children:"\u6536\u96c6\u548c\u5b58\u50a8\u65f6\u95f4\u5e8f\u5217\u6570\u636e\uff0cPrometheus Server \u662f Prometheus \u7ec4\u4ef6\u4e2d\u7684\u6838\u5fc3\u90e8\u5206\uff0c\u8d1f\u8d23\u5b9e\u73b0\u5bf9\u76d1\u63a7\u6570\u636e\u7684\u83b7\u53d6\uff0c\u5b58\u50a8\u4ee5\u53ca\u67e5\u8be2\u3002 Prometheus Server \u53ef\u4ee5\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u7ba1\u7406\u76d1\u63a7\u76ee\u6807\uff0c\u4e5f\u53ef\u4ee5\u914d\u5408\u4f7f\u7528 Service Discovery \u7684\u65b9\u5f0f\u52a8\u6001\u7ba1\u7406\u76d1\u63a7\u76ee\u6807\uff0c\u5e76\u4ece\u8fd9\u4e9b\u76d1\u63a7\u76ee\u6807\u4e2d\u83b7\u53d6\u6570\u636e\u3002\u5176\u6b21 Prometheus Server \u9700\u8981\u5bf9\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6570\u636e\u8fdb\u884c\u5b58\u50a8\uff0cPrometheus Server \u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u65f6\u5e8f\u6570\u636e\u5e93\uff0c\u5c06\u91c7\u96c6\u5230\u7684\u76d1\u63a7\u6570\u636e\u6309\u7167\u65f6\u95f4\u5e8f\u5217\u7684\u65b9\u5f0f\u5b58\u50a8\u5728\u672c\u5730\u78c1\u76d8\u5f53\u4e2d\u3002\u6700\u540e Prometheus Server \u5bf9\u5916\u63d0\u4f9b\u4e86\u81ea\u5b9a\u4e49\u7684 PromQL \u8bed\u8a00\uff0c\u5b9e\u73b0\u5bf9\u6570\u636e\u7684\u67e5\u8be2\u4ee5\u53ca"}),"\n",(0,l.jsx)(n.h3,{id:"132-node-exporter",children:"1.3.2 Node-Exporter"}),"\n",(0,l.jsx)(n.p,{children:"\u7528\u4e8e\u66b4\u9732\u5df2\u6709\u7684\u7b2c\u4e09\u65b9\u670d\u52a1\u7684 metrics \u7ed9 Prometheus\u3002Exporter \u5c06\u76d1\u63a7\u6570\u636e\u91c7\u96c6\u7684\u7aef\u70b9\u901a\u8fc7 HTTP \u670d\u52a1\u7684\u5f62\u5f0f\u66b4\u9732\u7ed9 Prometheus Server\uff0cPrometheus Server \u901a\u8fc7\u8bbf\u95ee\u8be5 Exporter \u63d0\u4f9b\u7684 Endpoint \u7aef\u70b9\uff0c\u5373\u53ef\u83b7\u53d6\u5230\u9700\u8981\u91c7\u96c6\u7684\u76d1\u63a7\u6570\u636e\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"133-grafana",children:"1.3.3 Grafana"}),"\n",(0,l.jsx)(n.p,{children:"\u7b2c\u4e09\u65b9\u5c55\u793a\u5de5\u5177\uff0c\u53ef\u4ee5\u7f16\u5199 PromQL \u67e5\u8be2\u8bed\u53e5\uff0c\u901a\u8fc7 http \u534f\u8bae\u4e0e prometheus \u96c6\u6210"}),"\n",(0,l.jsx)(n.h3,{id:"134-alertmanager",children:"1.3.4 AlertManager"}),"\n",(0,l.jsx)(n.p,{children:"\u4ece Prometheus Server \u7aef\u63a5\u6536\u5230 alerts \u540e\uff0c\u4f1a\u8fdb\u884c\u53bb\u9664\u91cd\u590d\u6570\u636e\uff0c\u5206\u7ec4\uff0c\u5e76\u8def\u7531\u5230\u5bf9\u65b9\u7684\u63a5\u53d7\u65b9\u5f0f\uff0c\u53d1\u51fa\u62a5\u8b66\u3002\u5e38\u89c1\u7684\u63a5\u6536\u65b9\u5f0f\u6709\uff1a\u7535\u5b50\u90ae\u4ef6\uff0c\u9489\u9489\u3001\u4f01\u4e1a\u5fae\u4fe1\uff0cpagerduty \u7b49"}),"\n",(0,l.jsx)(n.h3,{id:"135-push-gateway",children:"1.3.5 Push Gateway"}),"\n",(0,l.jsx)(n.p,{children:"\u4e3b\u8981\u7528\u4e8e\u77ed\u671f\u7684 jobs\u3002\u7531\u4e8e\u8fd9\u7c7b jobs \u5b58\u5728\u65f6\u95f4\u8f83\u77ed\uff0c\u53ef\u80fd\u5728 Prometheus \u6765 pull \u4e4b\u524d\u5c31\u6d88\u5931\u4e86\u3002\u4e3a\u6b64\uff0c\u8fd9\u4e9b jobs \u53ef\u4ee5\u76f4\u63a5\u5411 Prometheus server \u7aef\u63a8\u9001\u5b83\u4eec\u7684 metrics\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"14-prometheus-\u5de5\u4f5c\u6d41\u7a0b",children:"1.4 Prometheus \u5de5\u4f5c\u6d41\u7a0b"}),"\n",(0,l.jsx)(n.h3,{id:"141-\u6307\u6807\u91c7\u96c6",children:"1.4.1 \u6307\u6807\u91c7\u96c6"}),"\n",(0,l.jsx)(n.p,{children:"prometheus server \u901a\u8fc7 pull \u5f62\u5f0f\u91c7\u96c6\u76d1\u63a7\u6307\u6807\uff0c\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u76d1\u63a7\u6307\u6807\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 pushgateway \u505a\u4e2d\u95f4\u73af\u8282\uff0c\u76d1\u63a7\u76ee\u6807\u5148 push \u5f62\u5f0f\u4e0a\u62a5\u6570\u636e\u5230 pushgateway\uff1b"}),"\n",(0,l.jsx)(n.h3,{id:"142-\u6307\u6807\u5904\u7406",children:"1.4.2 \u6307\u6807\u5904\u7406"}),"\n",(0,l.jsx)(n.p,{children:"prometheus server \u5c06\u91c7\u96c6\u7684\u6570\u636e\u5b58\u50a8\u5728\u81ea\u8eab db \u6216\u8005\u7b2c\u4e09\u65b9 db\uff1b"}),"\n",(0,l.jsx)(n.h3,{id:"143-\u6307\u6807\u5c55\u793a",children:"1.4.3 \u6307\u6807\u5c55\u793a"}),"\n",(0,l.jsx)(n.p,{children:"prometheus server \u901a\u8fc7\u63d0\u4f9b http \u63a5\u53e3\uff0c\u63d0\u4f9b\u81ea\u5e26\u6216\u8005\u7b2c\u4e09\u65b9\u5c55\u793a\u7cfb\u7edf\uff1b"}),"\n",(0,l.jsx)(n.h3,{id:"144-\u6307\u6807\u544a\u8b66",children:"1.4.4 \u6307\u6807\u544a\u8b66"}),"\n",(0,l.jsx)(n.p,{children:'prometheus server \u901a\u8fc7 push \u544a\u8b66\u4fe1\u606f\u5230 alert-manager\uff0calert-manager \u901a\u8fc7"\u9759\u9ed8-\u6291\u5236-\u6574\u5408-\u4e0b\u53d1"4 \u4e2a\u9636\u6bb5\u5904\u7406\u901a\u77e5\u5230\u89c2\u5bdf\u8005'}),"\n",(0,l.jsx)(n.h2,{id:"15-prometheus-\u6307\u6807\u5206\u7c7b",children:"1.5 Prometheus \u6307\u6807\u5206\u7c7b"}),"\n",(0,l.jsx)(n.h3,{id:"151-counter",children:"1.5.1 Counter"}),"\n",(0,l.jsx)(n.p,{children:"\u8ba1\u6570\u5668\u7c7b\u578b\uff0c\u53ea\u589e\u4e0d\u51cf\uff0c\u5982\u673a\u5668\u7684\u542f\u52a8\u65f6\u95f4\uff0cHTTP \u8bbf\u95ee\u91cf\u7b49\u3002\u673a\u5668\u91cd\u542f\u4e0d\u4f1a\u7f6e\u96f6\uff0c\u5728\u4f7f\u7528\u8fd9\u79cd\u6307\u6807\u7c7b\u578b\u65f6\uff0c\u901a\u5e38\u4f1a\u7ed3\u5408 rate()\u65b9\u6cd5\u83b7\u53d6\u8be5\u6307\u6807\u5728\u67d0\u4e2a\u65f6\u95f4\u6bb5\u7684\u53d8\u5316\u7387\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"152-gauge",children:"1.5.2 Gauge"}),"\n",(0,l.jsx)(n.p,{children:"\u4eea\u8868\u76d8\uff0c\u53ef\u589e\u53ef\u51cf\uff0c\u5982 CPU \u4f7f\u7528\u7387\uff0c\u5927\u90e8\u5206\u76d1\u63a7\u6570\u636e\u90fd\u662f\u8fd9\u79cd\u7c7b\u578b\u7684\u3002"}),"\n",(0,l.jsx)(n.h3,{id:"153-summary",children:"1.5.3 Summary"}),"\n",(0,l.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5b9a\u4e49\uff0cSummary\uff0cHistogram \u90fd\u5c5e\u4e8e\u9ad8\u7ea7\u6307\u6807\uff0c\u7528\u4e8e\u51f8\u663e\u6570\u636e\u7684\u5206\u5e03\u60c5\u51b5\u3002"}),"\n",(0,l.jsx)(n.h1,{id:"2-\u5b89\u88c5-prometheus",children:"2. \u5b89\u88c5 prometheus"}),"\n",(0,l.jsx)(n.h3,{id:"21-\u83b7\u53d6\u955c\u50cf",children:"2.1 \u83b7\u53d6\u955c\u50cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker search prom/prometheus\ndocker pull prom/prometheus\n"})}),"\n",(0,l.jsx)(n.h3,{id:"22-\u521b\u5efa\u6301\u4e45\u5316\u8def\u5f84",children:"2.2 \u521b\u5efa\u6301\u4e45\u5316\u8def\u5f84"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir -p /data/docker/prometheus/{config,data,rules}\nchmod -R 777 /data/docker/prometheus\n"})}),"\n",(0,l.jsx)(n.h3,{id:"23-\u5199\u4e3b\u914d\u7f6e\u6587\u4ef6",children:"2.3 \u5199\u4e3b\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /data/docker/prometheus/config\ntouch prometheus.yml\nvi prometheus.yml\n\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'# my global config\nglobal:\n  # \u8bbe\u7f6e\u6293\u53d6\u6570\u636e\u7684\u65f6\u95f4\u95f4\u9694\uff0c\u95f4\u9694\u8bbe\u7f6e\u4e3a\u6bcf15\u79d2\u4e00\u6b21\u3002\u9ed8\u8ba4\u4e3a\u6bcf1\u5206\u949f\u3002\n  scrape_interval: 15s\n  # \u8bbe\u5b9a\u6293\u53d6\u6570\u636e\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba4\u4e3a10s\n  scrape_timeout: 15s\n  # \u8bbe\u7f6e\u89c4\u5219\u5237\u65b0\uff0c\u6bcf15\u79d2\u5237\u65b0\u4e00\u6b21\u89c4\u5219\u3002\u9ed8\u8ba4\u503c\u4e3a\u6bcf1\u5206\u949f\u3002\n  evaluation_interval: 60s\n\n# \u76d1\u63a7\u62a5\u8b66\u914d\u7f6e\uff08\u9700\u8981\u989d\u5916\u5b89\u88c5 alertmanager\u7ec4\u4ef6\uff09\nalerting:\n  alertmanagers:\n  - static_configs:\n    # \u8bbe\u5b9aalertmanager\u548cprometheus\u4ea4\u4e92\u7684\u63a5\u53e3\uff0c\u5373alertmanager\u76d1\u542c\u7684ip\u5730\u5740\u548c\u7aef\u53e3\n    - targets: ["localhost:9093"]\n\n# \u62a5\u8b66\u89c4\u5219\u6587\u4ef6\nrule_files:\n  - \'/data/docker/prometheus/rules/*.yml\'\n\n# \u666e\u7f57\u7c73\u4fee\u65af\u4e0e\u6293\u53d6\u6a21\u5757\u4ea4\u4e92\u7684\u63a5\u53e3\u914d\u7f6e\nscrape_configs:\n\t- job_name: \'prometheus\'\n    static_configs:\n    - targets: ["prometheus\u7684\u672c\u673a\u771f\u5b9eip:9090"]\n      labels:\n          instance: prometheus\n \n  - job_name: \'node-exporter\'\n    static_configs:\n    - targets: ["node\u8282\u70b9\u7684\u771f\u5b9eip:9100","node\u8282\u70b9\u7684\u771f\u5b9eip:9100","node\u8282\u70b9\u7684\u771f\u5b9eip:9100"]\n  \n  - job_name: \'alertmanager\'\n    static_configs:\n    - targets: ["alertmanager\u7684\u672c\u673a\u771f\u5b9eip:9093"]\n'})}),"\n",(0,l.jsx)(n.h3,{id:"24-\u521b\u5efa-rule-\u544a\u8b66\u9608\u503c",children:"2.4 \u521b\u5efa rule \u544a\u8b66\u9608\u503c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /data/docker/prometheus/rules\ntouch rule.yml\nvi rule.yml\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'groups:\n- name: Hosts.rules\n  rules:\n  - alert: HostDown           \n    expr: up{job=~"node-exporter|prometheus|grafana|alertmanager"} == 0\n    for: 0m\n    labels:\n      severity: ERROR\n    annotations:\n      title: \'Instance down\'\n      summary: "{{$labels.instance}}"\n      description: "\u4e3b\u673a: \u3010{{ $labels.instance }}\u3011has been down for more than 1 minute"\n## \u6ce8\u610f==0\u4e3a\u62a5\u8b66\u6761\u4ef6\uff0c\u5f53\u6709\u670d\u52a1\u5b95\u673a\u6d4b\u4f1a\u544a\u8b66\uff0c\u5982\u679c\u6d4b\u8bd5\u9700\u6539\u4e3a1\n\u6ce8\uff1a- alert: HostDown\u8fd9\u4e2a\u6570\u636e\u672c\u673a\u57fa\u672c\u6570\u636e\u7c7b\uff0c\u5982\u679c\u8981\u76d1\u63a7\u5176\u4ed6\u7684\u53ef\u4ee5\u8bbe\u7f6e\u4f8b\u5916\u7684\u540d\u5b57\n'})}),"\n",(0,l.jsx)(n.h3,{id:"25-\u8fd0\u884c\u5bb9\u5668",children:"2.5 \u8fd0\u884c\u5bb9\u5668"}),"\n",(0,l.jsx)(n.p,{children:"\u5c06\u5bf9\u5e94\u7684 rules \u6587\u4ef6\u4e0a\u4f20\u5230 /data/docker/prometheus/rules \u4e0b"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker run -d \\\n           -u root \\\n           --restart=always \\\n           --name prometheus \\\n           -p 9090:9090 \\\n           -v /etc/localtime:/etc/localtime \\\n           -v /data/docker/prometheus/config:/prometheus/config \\\n           -v /data/docker/prometheus/data:/prometheus/data \\\n           -v /data/docker/prometheus/rules:/prometheus/rules \\\n           prom/prometheus \\\n           --storage.tsdb.retention.time=100d \\\n           --web.enable-lifecycle \\\n           --config.file=/prometheus/config/prometheus.yml\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"--restart=always          \u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u81ea\u52a8\u91cd\u542f\u5bb9\u5668"}),"\n",(0,l.jsx)(n.p,{children:"-d  --detach=false        \u6307\u5b9a\u5bb9\u5668\u8fd0\u884c\u4e8e\u524d\u53f0\u8fd8\u662f\u540e\u53f0\uff0c\u9ed8\u8ba4\u4e3a false"}),"\n",(0,l.jsx)(n.p,{children:"--net                              \u7f51\u7edc\u6a21\u5f0f\uff0chost \u7f51\u7edc\u4e92\u901a\u6a21\u5f0f"}),"\n",(0,l.jsx)(n.p,{children:"--web.enable-lifecycle  \u70ed\u66f4\u65b0"}),"\n",(0,l.jsx)(n.p,{children:"-v \u7ed9\u5bb9\u5668\u6302\u8f7d\u5b58\u50a8\u5377\uff0c\u6302\u8f7d\u5230\u5bb9\u5668\u7684\u67d0\u4e2a\u76ee\u5f55(\u5bbf\u4e3b\u673a\u76ee\u5f55:/docker \u76ee\u5f55)\uff0c\u6ce8\u610f\u672c\u5730\u9700\u8981\u8981\u8be5\u6587\u4ef6"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"26-\u67e5\u770b\u4e3b\u670d\u52a1\u90e8\u7f72\u72b6\u51b5",children:"2.6 \u67e5\u770b\u4e3b\u670d\u52a1\u90e8\u7f72\u72b6\u51b5"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"http://localhost:9090",children:"http://localhost:9090"})}),"\n",(0,l.jsx)(n.h1,{id:"3-\u5b89\u88c5-node-exporter",children:"3. \u5b89\u88c5 node-exporter"}),"\n",(0,l.jsx)(n.p,{children:"\u8d1f\u8d23\u6536\u96c6 host \u786c\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7edf\u6570\u636e\uff0c\u5c06\u4ee5\u5bb9\u5668\u65b9\u5f0f\u8fd0\u884c\u5728\u6240\u6709 host \u4e0a"}),"\n",(0,l.jsx)(n.h3,{id:"31-\u83b7\u53d6\u955c\u50cf",children:"3.1 \u83b7\u53d6\u955c\u50cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker search node-exporter\ndocker pull prom/node-exporter\n"})}),"\n",(0,l.jsx)(n.h3,{id:"32-\u542f\u52a8\u5bb9\u5668",children:"3.2 \u542f\u52a8\u5bb9\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'docker run -d \\\n           -p 9100:9100 \\\n           --name node-exporter \\\n           --restart=always \\\n           -v "/proc:/host/proc:ro" \\\n           -v "/sys:/host/sys:ro" \\\n           -v "/:/rootfs:ro" \\\n           prom/node-exporter\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u9009\u9879\u8bf4\u660e:"}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"-d, --detach=false         \u6307\u5b9a\u5bb9\u5668\u8fd0\u884c\u4e8e\u524d\u53f0\u8fd8\u662f\u540e\u53f0[\u9ed8\u8ba4\u4e3a false]"}),"\n",(0,l.jsx)(n.p,{children:'--net="host"                  \u5bb9\u5668\u7f51\u7edc\u8bbe\u7f6e:'}),"\n",(0,l.jsx)(n.p,{children:"bridge                          \u4f7f\u7528 docker daemon \u6307\u5b9a\u7684\u7f51\u6865"}),"\n",(0,l.jsx)(n.p,{children:"host                              \u5bb9\u5668\u4f7f\u7528\u4e3b\u673a\u7684\u7f51\u7edc"}),"\n",(0,l.jsxs)(n.p,{children:["container",":NAME_or_ID"," >   \u4f7f\u7528\u5176\u4ed6\u5bb9\u5668\u7684\u7f51\u8def, \u5171\u4eab IP \u548c PORT \u7b49\u7f51\u7edc\u8d44\u6e90"]}),"\n",(0,l.jsx)(n.p,{children:"none                             \u5bb9\u5668\u4f7f\u7528\u81ea\u5df1\u7684\u7f51\u7edc(\u7c7b\u4f3c--net=bridge), \u4f46\u662f\u4e0d\u8fdb\u884c\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:"--cap-add=[]                   \u6dfb\u52a0\u6743\u9650, \u6743\u9650\u6e05\u5355\u5982\u4e0b, SYS_TIME:\u8bbe\u7f6e\u5b9e\u65f6\u65f6\u95f4"}),"\n",(0,l.jsx)(n.p,{children:'--pid="host"                   \u5c06 PID \u6a21\u5f0f\u8bbe\u7f6e\u4e3a\u4e3b\u673a PID \u6a21\u5f0f\u3002\u8fd9\u5c06\u6253\u5f00\u4e4b\u95f4\u7684\u5171\u4eab \u5bb9\u5668\u548c\u4e3b\u673a\u64cd\u4f5c\u7cfb\u7edf\u7684 PID \u5730\u5740\u7a7a\u95f4\u3002'}),"\n",(0,l.jsx)(n.p,{children:"\u200b                                         \u4f7f\u7528\u6b64\u6807\u5fd7\u542f\u52a8\u7684\u5bb9\u5668\u53ef\u4ee5\u8bbf\u95ee\u548c\u64cd\u4f5c\u5176\u4ed6 \u88f8\u673a\u8ba1\u7b97\u673a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u5bb9\u5668,\u53cd\u4e4b\u4ea6\u7136\u3002"}),"\n",(0,l.jsx)(n.p,{children:"-v                                     \u7ed9\u5bb9\u5668\u6302\u8f7d\u5b58\u50a8\u5377,\u6302\u8f7d\u5230\u5bb9\u5668\u7684\u67d0\u4e2a\u76ee\u5f55(/\u5bbf\u4e3b\u673a\u76ee\u5f55:/docker \u76ee\u5f55)"}),"\n",(0,l.jsx)(n.p,{children:"-e, --env=[]                     \u6307\u5b9a\u73af\u5883\u53d8\u91cf, \u5bb9\u5668\u4e2d\u53ef\u4ee5\u4f7f\u7528\u8be5\u73af\u5883\u53d8\u91cf, \u8bbe\u7f6e\u5bb9\u5668, HOST=ip, PORTO=\u7aef\u53e3"}),"\n",(0,l.jsx)(n.p,{children:"/start                              \u542f\u52a8\u4e4b\u540e\u8981\u6267\u884c\u7684\u547d\u4ee4(\u53ef\u4ee5\u662f shell \u4e5f\u53ef\u4ee5\u662f\u811a\u672c), \u5982\u5e26/bin/bash \u5219\u662f\u89e3\u91ca\u5668"}),"\n",(0,l.jsx)(n.p,{children:"\u200b                                        (\u6ce8:\u811a\u672c\u542f\u52a8\u5931\u8d25\u5219\u5bb9\u5668\u542f\u52a8\u5931\u8d25)"}),"\n",(0,l.jsx)(n.p,{children:"--restart=always           \u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u81ea\u52a8\u91cd\u542f\u5bb9\u5668"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"33-\u67e5\u770b",children:"3.3 \u67e5\u770b"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"http://localhost:9100/",children:"http://localhost:9100/"})}),"\n",(0,l.jsx)(n.h1,{id:"4-\u5b89\u88c5-alertmanager",children:"4. \u5b89\u88c5 alertmanager"}),"\n",(0,l.jsx)(n.h3,{id:"41-\u83b7\u53d6\u955c\u50cf",children:"4.1 \u83b7\u53d6\u955c\u50cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker search alertmanager\ndocker pull prom/alertmanager\n"})}),"\n",(0,l.jsx)(n.h3,{id:"42-\u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",children:"4.2 \u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir -p /data/docker/prometheus/alertmanager/{config,template}\nchmod -R 777 /data/docker/prometheus/alertmanager\n"})}),"\n",(0,l.jsx)(n.h3,{id:"43-\u544a\u8b66\u90ae\u4ef6\u914d\u7f6e",children:"4.3 \u544a\u8b66\u90ae\u4ef6\u914d\u7f6e"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /data/docker/prometheus/alertmanager/config\ntouch vi alertmanager.yml\nvi alertmanager.yml\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"global:\n  resolve_timeout: 5m \n  smtp_smarthost: 'smtp.qq.com:465'\n  smtp_from: 'xx@qq.com'\n  smtp_auth_username: 'xx@qq.com'  \n  # qq\u90ae\u7bb1\u6388\u6743\u7801\n  smtp_auth_password: 'xxxx'  \n  smtp_require_tls: false\n  smtp_hello: 'qq.com'\n\ntemplates:\n  # \u6307\u5b9a\u9884\u8b66\u5185\u5bb9\u6a21\u677f\n  - '/etc/alertmanager/template/*.tmpl'\n  \nroute:\n  group_by: ['alertname']\n  group_wait: 5s\n  group_interval: 5s\n  repeat_interval: 5m\n  receiver: 'email'\n  \nreceivers:\n  - name: 'email'\n    email_configs:\n    - to: 'xx@126.com'\n      html: '{{ template \"email.html\" . }}'\n      headers: { Subject: \"[WARN]\u544a\u8b66\" }\n      send_resolved: true\n"})}),"\n",(0,l.jsxs)(n.blockquote,{children:["\n",(0,l.jsx)(n.p,{children:"\u5168\u5c40\u914d\u7f6e(global):        \u7528\u4e8e\u5b9a\u4e49\u4e00\u4e9b\u5168\u5c40\u7684\u516c\u5171\u53c2\u6570\uff0c\u5982\u5168\u5c40\u7684 SMTP \u914d\u7f6e\uff0cSlack \u914d\u7f6e\u7b49\u5185\u5bb9\uff1b"}),"\n",(0,l.jsx)(n.p,{children:"\u6a21\u677f(templates):         \u7528\u4e8e\u5b9a\u4e49\u544a\u8b66\u901a\u77e5\u65f6\u7684\u6a21\u677f\uff0c\u5982 HTML \u6a21\u677f\uff0c\u90ae\u4ef6\u6a21\u677f\u7b49\uff1b"}),"\n",(0,l.jsx)(n.p,{children:"\u544a\u8b66\u8def\u7531(route):         \u6839\u636e\u6807\u7b7e\u5339\u914d\uff0c\u786e\u5b9a\u5f53\u524d\u544a\u8b66\u5e94\u8be5\u5982\u4f55\u5904\u7406\uff1b"}),"\n",(0,l.jsx)(n.p,{children:"\u63a5\u6536\u4eba(receivers):      \u63a5\u6536\u4eba\u662f\u4e00\u4e2a\u62bd\u8c61\u7684\u6982\u5ff5\uff0c\u5b83\u53ef\u4ee5\u662f\u4e00\u4e2a\u90ae\u7bb1\u4e5f\u53ef\u4ee5\u662f\u5fae\u4fe1\uff0cSlack \u6216\u8005 Webhook \u7b49\uff0c"}),"\n",(0,l.jsx)(n.p,{children:"\u200b                                     \u63a5\u6536\u4eba\u4e00\u822c\u914d\u5408\u544a\u8b66\u8def\u7531\u4f7f\u7528\uff1b"}),"\n",(0,l.jsx)(n.p,{children:"\u6291\u5236\u89c4\u5219(inhibit_rules): \u5408\u7406\u8bbe\u7f6e\u6291\u5236\u89c4\u5219\u53ef\u4ee5\u51cf\u5c11\u5783\u573e\u544a\u8b66\u7684\u4ea7\u751f"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"44-\u51c6\u5907\u9884\u8b66\u5185\u5bb9\u6a21\u677f\u6587\u4ef6",children:"4.4 \u51c6\u5907\u9884\u8b66\u5185\u5bb9\u6a21\u677f\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /data/docker/prometheus/alertmanager/template\ntouch email.tmpl\nvi email.tmpl\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'{{ define "email.html" }}             # \u544a\u8b66\u6807\u9898\u5728alertmagar\u5f15\u7528\n{{- if gt (len .Alerts.Firing) 0 -}}     # \u544a\u8b66\u6709\u4e24\u79cd\u72b6\u6001\uff08Firing\u548cResolved\uff09\n{{- range $index, $alert := .Alerts -}}  # \u683c\u5f0f\u4e66\u5199\n\n========= <span style=color:red;font-size:36px;font-weight:bold;> \u76d1\u63a7\u544a\u8b66 </span>=========<br>\n\u544a\u8b66\u7a0b\u5e8f:  Alertmanager <br>\n\u544a\u8b66\u7c7b\u578b:  {{ $alert.Labels.alertname }} <br>\n\u544a\u8b66\u7ea7\u522b:  {{ $alert.Labels.severity }} \u7ea7 <br>\n\u544a\u8b66\u72b6\u6001:  {{ .Status }} <br>\n\u6545\u969c\u4e3b\u673a:  {{ $alert.Labels.instance }} {{ $alert.Labels.device }} <br>\n\u544a\u8b66\u4e3b\u9898:  {{ .Annotations.summary }} <br>\n\u544a\u8b66\u8be6\u60c5:  {{ $alert.Annotations.message }}{{ $alert.Annotations.description}} <br>\n\u4e3b\u673a\u6807\u7b7e:  {{ range .Labels.SortedPairs  }} <br> [{{ .Name }}: {{ .Value  | html }} ]{{ end }}<br>\n\u6545\u969c\u65f6\u95f4:  {{ ($alert.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}<br>\n\n{{- end }}\n{{- end }}\n========== end =  =========\n{{- if gt (len .Alerts.Resolved) 0 -}}\n{{- range $index, $alert := .Alerts -}}\n========= <span style=color:#00FF00;font-size:24px;font-weight:bold;> \u544a\u8b66\u6062\u590d </span>=========<br>\n\u544a\u8b66\u7a0b\u5e8f: Alertmanager <br>\n\u544a\u8b66\u7c7b\u578b: {{ $alert.Labels.alertname }} <br>\n\u544a\u8b66\u7ea7\u522b: {{ $alert.Labels.severity }} \u7ea7 <br>\n\u544a\u8b66\u72b6\u6001: {{ .Status }} <br>\n\u6545\u969c\u4e3b\u673a: {{ $alert.Labels.instance }} {{ $alert.Labels.device }} <br>\n\u544a\u8b66\u4e3b\u9898: {{ .Annotations.summary }} <br>\n\u544a\u8b66\u8be6\u60c5: {{ $alert.Annotations.message }}{{ $alert.Annotations.description}} <br>\n\u4e3b\u673a\u6807\u7b7e: {{ range .Labels.SortedPairs  }} <br> [{{ .Name }}: {{ .Value  | html }} ]{{ end }}<br>\n\u6545\u969c\u65f6\u95f4: {{ ($alert.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}<br>\n{{- end }}\n{{- end }}\n========== end =  =========\n{{- end }}\n\n\n{{ define "email.html" }}\n<table border="1">\n    <tr>\n        <td>\u62a5\u8b66\u9879</td>\n        <td>\u5b9e\u4f8b</td>\n        <td>\u62a5\u8b66\u9600\u503c</td>\n        <td>\u5f00\u59cb\u65f6\u95f4</td>\n        <td>\u544a\u8b66\u4fe1\u606f</td>\n    </tr>\n    {{ range $i, $alert := .Alerts }}\n        <tr>\n            <td>{{ index $alert.Labels "alertname" }}</td>\n            <td>{{ index $alert.Labels "instance" }}</td>\n            <td>{{ index $alert.Annotations "value" }}</td>\n            <td>{{ $alert.StartsAt }}</td>\n            <td>{{ index $alert.Annotations "description" }}</td>\n        </tr>\n    {{ end }}\n</table>\n{{ end }}\n'})}),"\n",(0,l.jsx)(n.h3,{id:"45-\u542f\u52a8\u5bb9\u5668",children:"4.5 \u542f\u52a8\u5bb9\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker run -d --name=alertmanager \\\n    -p 9093:9093 \\\n    --restart=always \\\n    -v /etc/localtime:/etc/localtime:ro \\\n    -v /data/docker/prometheus/alertmanager/config/alertmanager.yml:/alertmanager/config/alertmanager.yml \\\n    -v /data/docker/prometheus/alertmanager/template:/alertmanager/template \\\n    prom/alertmanager\n"})}),"\n",(0,l.jsx)(n.h3,{id:"46-\u67e5\u770b\u5e76\u7b49\u5f85\u544a\u8b66",children:"4.6 \u67e5\u770b\u5e76\u7b49\u5f85\u544a\u8b66"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"http://localhost:9093",children:"http://localhost:9093"})}),"\n",(0,l.jsx)(n.h1,{id:"5-\u5b89\u88c5-grafana",children:"5. \u5b89\u88c5 grafana"}),"\n",(0,l.jsx)(n.h3,{id:"51-\u83b7\u53d6\u955c\u50cf",children:"5.1 \u83b7\u53d6\u955c\u50cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"docker search grafana\ndocker pull grafana/grafana\n"})}),"\n",(0,l.jsx)(n.h3,{id:"52-\u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55",children:"5.2 \u521b\u5efa\u6301\u4e45\u5316\u76ee\u5f55"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir -p /data/docker/prometheus/grafana/{data,plugins,config}\nchmod 777 -R /data/docker/prometheus/grafana\n"})}),"\n",(0,l.jsx)(n.h3,{id:"53-\u542f\u52a8\u5bb9\u5668",children:"5.3 \u542f\u52a8\u5bb9\u5668"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# \u5148\u4e34\u65f6\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\ndocker run --name grafana-tmp -d -p 3000:3000 grafana/grafana\n# \u5c06\u5bb9\u5668\u4e2d\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\u62f7\u8d1d\u5230\u5bbf\u4e3b\u673a\u4e0a\ndocker cp grafana-tmp:/etc/grafana/grafana.ini /data/docker/prometheus/grafana/config/grafana.ini\n# \u79fb\u9664\u4e34\u65f6\u5bb9\u5668\ndocker stop grafana-tmp\ndocker rm grafana-tmp\n\ndocker run -d \\\n           -p 3000:3000 \\\n           --name=grafana \\\n           --restart=always \\\n           -v /etc/localtime:/etc/localtime:ro \\\n           -v /data/docker/prometheus/grafana/data:/var/lib/grafana \\\n           -v /data/docker/prometheus/grafana/plugins/:/var/lib/grafana/plugins \\\n           -v /data/prometheus/grafana/config/grafana.ini:/etc/grafana/grafana.ini \\\n           -e "GF_SECURITY_ADMIN_PASSWORD=admin" \\\n           -e "GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel" \\\n           grafana/grafana\n'})}),"\n",(0,l.jsxs)(n.p,{children:["\u8bbf\u95ee",(0,l.jsx)(n.code,{children:"{ip}:3000"}),"\u5373\u53ef\uff0c\u4f7f\u7528\u8d26\u5bc6 admin/admin \u8fdb\u884c\u767b\u5f55\u5373\u53ef"]}),"\n",(0,l.jsx)(n.h1,{id:"6docker-compose-\u542f\u52a8-prometheus",children:"6.docker-compose \u542f\u52a8 prometheus"}),"\n",(0,l.jsx)(n.p,{children:"\u76ee\u5f55\u7ed3\u6784:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"\u251c\u2500\u2500 .env\n\u251c\u2500\u2500 delete-container.sh\n\u251c\u2500\u2500 docker-compose.yml\n\u2514\u2500\u2500 start.sh\n"})}),"\n",(0,l.jsx)(n.h2,{id:"61-env",children:"6.1 .env"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-properties",children:"prometheus_local_dir=/data/docker/prometheus\nalertmanager_local_dir=/data/docker/prometheus/alertmanager\ngrafana_local_dir=/data/docker/prometheus/grafana\n"})}),"\n",(0,l.jsx)(n.h2,{id:"62-docker-composeyml",children:"6.2 docker-compose.yml"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"version: '3'\nservices:\n  # \u6dfb\u52a0 \u666e\u7f57\u7c73\u4fee\u65af\u670d\u52a1\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    hostname: prometheus\n    restart: always\n    user: root\n    ports:\n      - '9090:9090'\n    volumes:\n      - /etc/localtime:/etc/localtime\n      - ${prometheus_local_dir}/config:/prometheus/config\n      - ${prometheus_local_dir}/data/docker:/prometheus/data\n      - ${prometheus_local_dir}/rules:/prometheus/rules\n    # \u6307\u5b9a\u5bb9\u5668\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\n    command:\n      # \u652f\u6301\u70ed\u66f4\u65b0\n      - '--web.enable-lifecycle'\n      # \u4fdd\u7559100\u5929\u7684\u6570\u636e\n      - '--storage.tsdb.retention.time=100d'\n      - '--storage.tsdb.path=/prometheus'\n      - '--config.file=/prometheus/config/prometheus.yml'\n\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: node-exporter\n    hostname: node-exporter\n    restart: always\n    ports:\n      - \"9100:9100\"\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n\n\n\n  # \u6dfb\u52a0\u544a\u8b66\u6a21\u5757\n  alertmanager:\n    image: prom/alertmanager:latest\n    container_name: alertmanager\n    hostname: alertmanager\n    restart: always\n    ports:\n      - '9093:9093'\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ${alertmanager_local_dir}/config/alertmanager.yml:/alertmanager/config/alertmanager.yml\n      - ${alertmanager_local_dir}/template:/alertmanager/template\n    command:\n      - '--config.file=/alertmanager/config/alertmanager.yml'\n\n  # \u6dfb\u52a0\u76d1\u63a7\u53ef\u89c6\u5316\u9762\u677f\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    hostname: grafana\n    restart: always\n    user: root\n    ports:\n      - '3000:3000'\n    volumes:\n      - /etc/localtime:/etc/localtime:ro\n      - ${grafana_local_dir}/data/docker:/var/lib/grafana\n      - ${grafana_local_dir}/plugins/:/var/lib/grafana/plugins\n      - ${grafana_local_dir}/config/grafana.ini:/etc/grafana/grafana.ini\n    environment:\n      - '-GF_SECURITY_ADMIN_PASSWORD=admin'\n      - \"-GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel\"\n\n\n  cadvisor:\n    image: gcr.io/cadvisor/cadvisor:latest\n    container_name: cadvisor\n    hostname: cadvisor\n    restart: always\n    ports:\n      - \"9200:8080\"\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:ro\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n\n"})}),"\n",(0,l.jsx)(n.h2,{id:"63-startsh",children:"6.3 start.sh"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"#/bin/bash\ndocker-compose -p prometheus down  --remove-orphans\ndocker-compose -p prometheus -f ./docker-compose.yml up -d\n"})}),"\n",(0,l.jsx)(n.h2,{id:"64-delete-containersh",children:"6.4 delete-container.sh"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"#/bin/bash\ndocker-compose -p prometheus down --remove-orphans\n"})}),"\n",(0,l.jsx)(n.h1,{id:"7-\u76d1\u63a7-oracle",children:"7. \u76d1\u63a7 Oracle"}),"\n",(0,l.jsx)(n.h2,{id:"71-\u8f6f\u4ef6\u5305",children:"7.1 \u8f6f\u4ef6\u5305"}),"\n",(0,l.jsx)(n.p,{children:"oracle-instantclient12.2-basic-12.2.0.1.0-1.x86_64.rpm"}),"\n",(0,l.jsxs)(n.p,{children:["\u4e0b\u8f7d\u5730\u5740: ",(0,l.jsx)(n.a,{href:"https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html",children:"https://www.oracle.com/database/technologies/instant-client/linux-x86-64-downloads.html"})]}),"\n",(0,l.jsx)(n.p,{children:"oracledb_exporter.tar.gz: \u4e8c\u8fdb\u5236\u6587\u4ef6"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://github.com/iamseth/oracledb_exporter/releases/download/0.5.0/oracledb_exporter.tar.gz",children:"https://github.com/iamseth/oracledb_exporter/releases/download/0.5.0/oracledb_exporter.tar.gz"})}),"\n",(0,l.jsx)(n.p,{children:"oracledb_exporter-0.5.0.tar.gz: \u6e90\u4ee3\u7801\u6587\u4ef6\u5305\u542b\u914d\u7f6e"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://github.com/iamseth/oracledb_exporter/archive/refs/tags/0.5.0.tar.gz",children:"https://github.com/iamseth/oracledb_exporter/archive/refs/tags/0.5.0.tar.gz"})}),"\n",(0,l.jsx)(n.p,{children:"\u8bf4\u660e:"}),"\n",(0,l.jsx)(n.p,{children:"oracledb_exporterer \u8fde\u63a5 oracle \u6570\u636e\u5e93\uff0c\u9700\u4f9d\u8d56 oracle client\uff0c\u56e0\u6b64\u4e5f\u8981\u63d0\u524d\u4e0b\u8f7d\u597d oracle client\u3002"}),"\n",(0,l.jsx)(n.h2,{id:"72-\u5b89\u88c5-oracle-instantclient",children:"7.2 \u5b89\u88c5 oracle-instantclient"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"rpm -ivh oracle-instantclient12.2-basic-12.2.0.1.0-1.x86_64.rpm \n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u5b89\u88c5\u7684\u6587\u4ef6\u9ed8\u8ba4\u653e\u5728\u4e24\u4e2a\u4f4d\u7f6e\uff1a\n\u5305\u6587\u4ef6\uff1a",(0,l.jsx)(n.code,{children:"/usr/lib/oracle/12.2/client64"})," \u4e0b\uff0c\u5305\u542b{bin\u3001lib}\u4e24\u4e2a\u6587\u4ef6\u5939."]}),"\n",(0,l.jsx)(n.h3,{id:"721-\u521b\u5efa-tnsname",children:"7.2.1 \u521b\u5efa tnsname"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"mkdir /usr/lib/oracle/12.2/client64/network/admin -p\ncd /usr/lib/oracle/12.2/client64/network/admin\ntouch tnsnames.ora\nvi tnsnames.ora\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"{SID} =\n   (DESCRIPTION =\n       (ADDRESS = (PROTOCOL = TCP)(HOST = {ip})(PORT = 1521))\n       (CONNECT_DATA =\n          (SERVER = DEDICATED)\n          (SERVICE_NAME = {sid})\n       )\n   )\nEOF\n"})}),"\n",(0,l.jsx)(n.h3,{id:"722-\u914d\u7f6e-oracle-\u5ba2\u6237\u7aef\u73af\u5883\u53d8\u91cf",children:"7.2.2 \u914d\u7f6e oracle \u5ba2\u6237\u7aef\u73af\u5883\u53d8\u91cf"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /etc/profile.d\ntouch oracledb_exporter.sh\nvi oracledb_exporter.sh\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"export TNS_ADMIN=/usr/lib/oracle/12.2/client64/network/admin\nexport DATA_SOURCE_NAME=oracle://system:{password}@{ip}:1521/{sid}\nexport LD_LIBRARY_PATH=/usr/lib/oracle/12.2/client64/lib\nexport PATH=/usr/lib/oracle/12.2/client64/bin:$PATH\n"})}),"\n",(0,l.jsxs)(n.p,{children:["\u4f7f\u914d\u7f6e\u5b8c\u7684\u73af\u5883\u53d8\u91cf\u751f\u6548 ",(0,l.jsx)(n.code,{children:"source /etc/profile.d/oracledb_exporter.sh"})]}),"\n",(0,l.jsx)(n.h2,{id:"73-\u5b89\u88c5-oracledb_exporter",children:"7.3 \u5b89\u88c5 oracledb_exporter"}),"\n",(0,l.jsx)(n.h3,{id:"731-\u89e3\u538b-oracledb_exporter-\u6267\u884c\u6587\u4ef6",children:"7.3.1 \u89e3\u538b oracledb_exporter \u6267\u884c\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"tar -zxvf oracledb_exporter.tar.gz -C /opt\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u89e3\u538b\u540e\u6587\u4ef6\u76ee\u5f55:\n\u2514\u2500\u2500 oracledb_exporter"}),"\n",(0,l.jsx)(n.h3,{id:"732-\u89e3\u538b-oracledb_exporter-\u6e90\u6587\u4ef6",children:"7.3.2 \u89e3\u538b oracledb_exporter \u6e90\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"tar -zxvf oracledb_exporter-0.5.0.tar.gz\n\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u6587\u4ef6\u76ee\u5f55:"}),"\n",(0,l.jsx)(n.p,{children:"\u251c\u2500\u2500 Dockerfile\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 alpine\n\u251c\u2500\u2500 collector\n\u251c\u2500\u2500 custom-metrics-example\n\u251c\u2500\u2500 default-asm-metrics.toml\n\u251c\u2500\u2500 default-metrics.legacy-tablespace.toml\n\u251c\u2500\u2500 default-metrics.toml\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 main.go\n\u251c\u2500\u2500 metric-dual-example.toml\n\u251c\u2500\u2500 metric-histogram-example.toml\n\u251c\u2500\u2500 multi-metric-dual-example-labels.toml\n\u251c\u2500\u2500 operating-principles.md\n\u251c\u2500\u2500 oraclelinux\n\u251c\u2500\u2500 systemd-example\n\u2514\u2500\u2500 tests"}),"\n",(0,l.jsx)(n.p,{children:"\u590d\u5236\u9ed8\u8ba4\u6307\u6807\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cp oracledb_exporter-0.5.0/default-metrics.toml /opt/oracledb_exporter-0.5.0.linux-amd64/\n"})}),"\n",(0,l.jsx)(n.h3,{id:"733-\u521b\u5efa\u542f\u52a8\u811a\u672c",children:"7.3.3 \u521b\u5efa\u542f\u52a8\u811a\u672c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /opt/oracledb_exporter-0.5.0.linux-amd64/\nvi start.sh\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\nnohup ./oracledb_exporter --log.level warn --web.listen-address=0.0.0.0:9161 --default.metrics ./default-metrics.toml > ./output.log &\n"})}),"\n",(0,l.jsx)(n.h3,{id:"734-\u542f\u52a8-oracledb_exporter",children:"7.3.4 \u542f\u52a8 oracledb_exporter"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"sh ./start.sh\n"})}),"\n",(0,l.jsx)(n.h3,{id:"735-\u786e\u8ba4\u542f\u52a8\u662f\u5426\u6210\u529f",children:"7.3.5 \u786e\u8ba4\u542f\u52a8\u662f\u5426\u6210\u529f"}),"\n",(0,l.jsxs)(n.p,{children:["\u6d4f\u89c8\u5668\u6253\u5f00 ",(0,l.jsx)(n.code,{children:"http://{ip}:9161/metrics"})]}),"\n",(0,l.jsx)(n.p,{children:"\u622a\u53d6\u90e8\u5206\u5185\u5bb9"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'go_threads 20\n# HELP oracledb_activity_execute_count Generic counter metric from v$sysstat view in Oracle.\n# TYPE oracledb_activity_execute_count gauge\noracledb_activity_execute_count 8.891983314e+09\n# HELP oracledb_activity_parse_count_total Generic counter metric from v$sysstat view in Oracle.\n# TYPE oracledb_activity_parse_count_total gauge\noracledb_activity_parse_count_total 3.553429672e+09\n# HELP oracledb_activity_user_commits Generic counter metric from v$sysstat view in Oracle.\n# TYPE oracledb_activity_user_commits gauge\noracledb_activity_user_commits 3.0688661e+07\n# HELP oracledb_activity_user_rollbacks Generic counter metric from v$sysstat view in Oracle.\n# TYPE oracledb_activity_user_rollbacks gauge\noracledb_activity_user_rollbacks 154234\n# HELP oracledb_exporter_build_info A metric with a constant \'1\' value labeled by version, revision, branch, goversion from which oracledb_exporter was built, and the goos and goarch for the build.\n# TYPE oracledb_exporter_build_info gauge\noracledb_exporter_build_info{branch="",goarch="amd64",goos="linux",goversion="go1.19.4",revision="c951abb83a79c37a608f809378333895244f5ba5",tags="unknown",version=""} 1\n# HELP oracledb_exporter_last_scrape_duration_seconds Duration of the last scrape of metrics from Oracle DB.\n# TYPE oracledb_exporter_last_scrape_duration_seconds gauge\noracledb_exporter_last_scrape_duration_seconds 0.388182934\n# HELP oracledb_exporter_last_scrape_error Whether the last scrape of metrics from Oracle DB resulted in an error (1 for error, 0 for success).\n# TYPE oracledb_exporter_last_scrape_error gauge\noracledb_exporter_last_scrape_error 0\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u81f3\u6b64 oracledb_exporter \u5b89\u88c5\u6210\u529f"}),"\n",(0,l.jsx)(n.h2,{id:"74-prometheus-\u96c6\u6210-oracledb_exporter",children:"7.4 Prometheus \u96c6\u6210 oracledb_exporter"}),"\n",(0,l.jsx)(n.h3,{id:"741-\u914d\u7f6e\u76d1\u542c",children:"7.4.1 \u914d\u7f6e\u76d1\u542c"}),"\n",(0,l.jsx)(n.p,{children:"\u914d\u7f6e prometheus"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"vi /data/docker/prometheus/config/prometheus.yml\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u65b0\u589e:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"- job_name: 'oracle'\n    static_configs:\n      - targets: ['{\u6570\u636e\u5e93\u4e3b\u673aip}:9161']\n"})}),"\n",(0,l.jsx)(n.h3,{id:"742-\u914d\u7f6e\u544a\u8b66\u89c4\u5219",children:"7.4.2 \u914d\u7f6e\u544a\u8b66\u89c4\u5219"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd /data/docker/prometheus/rules\ntouch oracle.yml\nvi oracle.yml\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:'groups:\n- name: Oracle.rules\n  rules:\n  - alert: TableSpaceWarning           \n    expr: oracledb_tablespace_used_percent{tablespace=~".+",type="PERMANENT"} > 80\n    for: 30s\n    labels:\n      severity: WARNING\n    annotations:\n      title: \'\u6570\u636e\u5e93\u8868\u7a7a\u95f4\u9884\u8b66\'\n      description: "\u4e3b\u673a: [{{$labels.instance}}] \u8868\u7a7a\u95f4 [{{$labels.tablespace}}] \u4f7f\u7528\u7387\u8d85\u8fc780%, \u5f53\u524d: {{ $value }}%"\n\n'})}),"\n",(0,l.jsx)(n.h1,{id:"8-\u544a\u8b66",children:"8. \u544a\u8b66"}),"\n",(0,l.jsx)(n.h2,{id:"81-\u90ae\u4ef6\u544a\u8b66",children:"8.1 \u90ae\u4ef6\u544a\u8b66"}),"\n",(0,l.jsx)(n.p,{children:"\u90ae\u4ef6\u544a\u8b66\u524d\u9762\u5df2\u7ecf\u8bbe\u7f6e\u597d\u4e86\uff0c\u53c2\u7167 \u5b89\u88c5 alertmanager"}),"\n",(0,l.jsx)(n.h2,{id:"82-\u9489\u9489\u544a\u8b66",children:"8.2 \u9489\u9489\u544a\u8b66"}),"\n",(0,l.jsx)(n.h3,{id:"821-\u6dfb\u52a0\u9489\u9489\u544a\u8b66\u673a\u5668\u4eba",children:"8.2.1 \u6dfb\u52a0\u9489\u9489\u544a\u8b66\u673a\u5668\u4eba"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://cdn.nlark.com/yuque/0/2023/png/22370594/1685435921767-4a51e17d-0fc4-43b1-924c-84817201aab2.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0",alt:"image.png"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://img-blog.csdnimg.cn/0910373b6dca47b0af66591af6be68ac.png",alt:"\u81ea\u5b9a\u4e49\u673a\u5668\u4eba.png"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://img-blog.csdnimg.cn/78d4afda5e434167a03f651f32c49360.png",alt:"\u6dfb\u52a0\u673a\u5668\u4eba.png"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://img-blog.csdnimg.cn/7be5b07ad2e447158895a97cdf863c66.png",alt:"\u521b\u5efa\u5b8c\u6210.png"})}),"\n",(0,l.jsxs)(n.p,{children:["Sign:  ",(0,l.jsx)(n.code,{children:"SEC4a95e85cb40e3a5155639963bf105ef94407cdd706c6d1ba5c3227c63f88ce6f"})]}),"\n",(0,l.jsxs)(n.p,{children:["Webhook: ",(0,l.jsx)(n.code,{children:"https://oapi.dingtalk.com/robot/send?access_token=1141e53e8263b3cdec4a89a285c81fec2de129b8ae9769df5980a455b591c575"})]}),"\n",(0,l.jsx)(n.h3,{id:"822-\u5b89\u88c5\u63d2\u4ef6",children:"8.2.2 \u5b89\u88c5\u63d2\u4ef6"}),"\n",(0,l.jsx)(n.h4,{id:"8221-\u4e0b\u8f7d\u63d2\u4ef6",children:"8.2.2.1 \u4e0b\u8f7d\u63d2\u4ef6"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.a,{href:"https://github.com/timonwong/prometheus-webhook-dingtalk/releases/",children:"https://github.com/timonwong/prometheus-webhook-dingtalk/releases/"}),"\nwget ",(0,l.jsx)(n.a,{href:"https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz",children:"https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz"})]}),"\n",(0,l.jsx)(n.h4,{id:"8222-\u5b89\u88c5",children:"8.2.2.2 \u5b89\u88c5"}),"\n",(0,l.jsx)(n.p,{children:"tar -xvf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz -C /usr/local\ncd /usr/local\nmv prometheus-webhook-dingtalk-2.1.0.linux-amd64 prometheus-webhook-dingtalk"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"cd prometheus-webhook-dingtalk\nmv config.example.yml config.yml\n\nmkdir templates\nmv contrib/templates/legacy/template.tmpl templates/\n\n#\u5220\u9664\u591a\u4f59\u6587\u4ef6\nrm -rf contrib\n"})}),"\n",(0,l.jsx)(n.h4,{id:"8223-\u4fee\u6539\u9489\u9489\u544a\u8b66\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6",children:"8.2.2.3 \u4fee\u6539\u9489\u9489\u544a\u8b66\u63d2\u4ef6\u914d\u7f6e\u6587\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"vi config.yml\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"timeout: 5s\ntemplates:\n  - templates/template.tmpl\n\ntargets:\n  webhook1:\n    url: https://oapi.dingtalk.com/robot/send?access_token=1141e53e8263b3cdec4a89a285c81fec2de129b8ae9769df5980a455b591c575\n    secret: SEC4a95e85cb40e3a5155639963bf105ef94407cdd706c6d1ba5c3227c63f88ce6f\n\n"})}),"\n",(0,l.jsx)(n.p,{children:"url \u548c secret \u4e3a\u521b\u5efa\u9489\u9489\u673a\u5668\u4eba\u8fc7\u7a0b\u4e2d\u8bb0\u5f55\u4e0b\u6765\u7684\u503c"}),"\n",(0,l.jsx)(n.h4,{id:"8224-\u4fee\u6539\u9489\u9489\u544a\u8b66\u6a21\u677f",children:"8.2.2.4 \u4fee\u6539\u9489\u9489\u544a\u8b66\u6a21\u677f"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"vi /templates/template.tmpl\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u5185\u5bb9\u4e3a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'{{ define "__subject" }}\n[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]\n{{ end }}\n \n \n{{ define "__alert_list" }}{{ range . }}\n---\n{{ if .Labels.owner }}@{{ .Labels.owner }}{{ end }}\n\u544a\u8b66\u7a0b\u5e8f:  Alertmanager\n\n\u544a\u8b66\u540d\u79f0: {{ .Labels.alertname }} \n\n\u544a\u8b66\u7ea7\u522b: {{ .Labels.severity }}\n\n\u544a\u8b66\u72b6\u6001: {{ .Status }}\n\n\u544a\u8b66\u4e3b\u673a: {{ .Labels.instance }} \n\n\u544a\u8b66\u4e3b\u9898: {{ .Annotations.title }}\n\n\u544a\u8b66\u4fe1\u606f: {{ .Annotations.description}}\n\n\u544a\u8b66\u65f6\u95f4: {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}\n\n{{ end }}{{ end }}\n\n \n{{ define "__resolved_list" }}{{ range . }}\n---\n{{ if .Labels.owner }}@{{ .Labels.owner }}{{ end }}\n\u544a\u8b66\u7a0b\u5e8f:  Alertmanager\n\n\u544a\u8b66\u540d\u79f0: {{ .Labels.alertname }} \n\n\u544a\u8b66\u7ea7\u522b: {{ .Labels.severity }}\n\n\u544a\u8b66\u72b6\u6001: {{ .Status }}\n\n\u544a\u8b66\u4e3b\u673a: {{ .Labels.instance }} \n\n\u544a\u8b66\u4e3b\u9898: {{ .Annotations.title }}\n\n\u544a\u8b66\u4fe1\u606f: {{ .Annotations.description}}\n\n\u544a\u8b66\u65f6\u95f4: {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}\n\n{{ end }}{{ end }}\n \n \n{{ define "default.title" }}\n{{ template "__subject" . }}\n{{ end }}\n \n{{ define "default.content" }}\n{{ if gt (len .Alerts.Firing) 0 }}\n**====\u4fa6\u6d4b\u5230{{ .Alerts.Firing | len  }}\u4e2a\u6545\u969c====**\n{{ template "__alert_list" .Alerts.Firing }}\n---\n{{ end }}\n \n{{ if gt (len .Alerts.Resolved) 0 }}\n**====\u6062\u590d{{ .Alerts.Resolved | len  }}\u4e2a\u6545\u969c====**\n{{ template "__resolved_list" .Alerts.Resolved }}\n{{ end }}\n{{ end }}\n \n \n{{ define "ding.link.title" }}{{ template "default.title" . }}{{ end }}\n{{ define "ding.link.content" }}{{ template "default.content" . }}{{ end }}\n{{ template "default.title" . }}\n{{ template "default.content" . }}\n\n'})}),"\n",(0,l.jsx)(n.h4,{id:"8225-\u542f\u52a8\u544a\u8b66\u63d2\u4ef6",children:"8.2.2.5 \u542f\u52a8\u544a\u8b66\u63d2\u4ef6"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"./prometheus-webhook-dingtalk --config.file=config.yml \n"})}),"\n",(0,l.jsx)(n.h4,{id:"8226-\u4fee\u6539-alertmanager-\u544a\u8b66",children:"8.2.2.6 \u4fee\u6539 alertManager \u544a\u8b66"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"vi /data/docker/prometheus/alertmanager/config/alertmanager.yml\n"})}),"\n",(0,l.jsx)(n.p,{children:"route \u90e8\u5206"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-yaml",children:"route:\n  group_by: ['alertname']\n  group_wait: 30s\n  group_interval: 30s\n  repeat_interval: 30s\n  receiver: dingtalk-webhook\n  routes:\n    - receiver: dingtalk-webhook\n      group_wait: 10s\n\n    - receiver: email\n      group_wait: 10s\n"})}),"\n",(0,l.jsx)(n.p,{children:"receivers \u90e8\u5206:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"receivers:\n  - name: 'email'\n    email_configs:\n    - to: 'exfoide@126.com'\n      send_resolved: true\n      html: '{{ template \"email.html\" . }}'\n      headers: { Subject: \"[WARN]\u544a\u8b66\" }\n  \n  - name: 'dingtalk-webhook' \n    webhook_configs:\n    - url: 'http://{\u9489\u9489\u63d2\u4ef6\u90e8\u7f72\u4e3b\u673aip}:8060/dingtalk/webhook1/send'\n      send_resolved: true\n"})}),"\n",(0,l.jsx)(n.p,{children:"webhook_configs.url \u4e3a\u90e8\u7f72 prometheus-webhook-dingtalk \u7684\u673a\u5668, webhook1 \u9700\u8981\u548c config.yml \u4e2d\u4fdd\u6301\u4e00\u81f4"}),"\n",(0,l.jsx)(n.h4,{id:"8227-\u91cd\u542f-alertmanager",children:"8.2.2.7 \u91cd\u542f AlertManager"}),"\n",(0,l.jsx)(n.h4,{id:"8228-\u67e5\u770b\u544a\u8b66\u662f\u5426\u751f\u6210",children:"8.2.2.8 \u67e5\u770b\u544a\u8b66\u662f\u5426\u751f\u6210"}),"\n",(0,l.jsx)(n.p,{children:"\u8fdb\u5165 Prometheus \u9762\u677f"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://cdn.nlark.com/yuque/0/2023/png/22370594/1685437183708-1d505db3-ee6b-4912-93ba-ce5a6af51da7.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0",alt:"image.png"})}),"\n",(0,l.jsx)(n.h4,{id:"8229-\u9489\u9489\u544a\u8b66\u4fe1\u606f",children:"8.2.2.9 \u9489\u9489\u544a\u8b66\u4fe1\u606f"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{src:"https://cdn.nlark.com/yuque/0/2023/png/22370594/1685437446515-7ab1ed92-35d5-4e23-814d-05f7c253d251.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0",alt:"image.png"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}}}]);